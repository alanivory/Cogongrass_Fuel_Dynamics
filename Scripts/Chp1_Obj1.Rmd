---
title: "Chapter1 Objective1"
author: "Alan Ivory"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup_All}
pacman::p_load(dplyr, readxl, tidyverse, raster, vegan, tigris, sf, sp, plotly, ggrepel, kableExtra, brms, parameters, gt, katex, emmeans, bayestestR, cowplot, ggeffects, patchwork)

## Set seed
set.seed(97)

# Tree PCQ Data
tree_data <- read_excel("C:/Users/DrewIvory/OneDrive - University of Florida/Desktop/School/PHD/01_Projects/05_SharedData/Field_Data_FL_AL_MS.xlsx",
                        sheet = "Tree_PCQ")
tree_data <- tree_data %>%
  filter(Site %in% c("BRSF", "WSF", "Jay"))

# Soil Data
fuel_data <- read_excel("C:/Users/DrewIvory/OneDrive - University of Florida/Desktop/School/PHD/01_Projects/05_SharedData/Field_Data_FL_AL_MS.xlsx",
                        sheet = "Fuel_Sampling")
fuel_data <- fuel_data %>%
  filter(Site %in% c("BRSF", "WSF", "Jay"))

Seasonal_Fuel_Sampling <- read_excel("C:/Users/DrewIvory/OneDrive - University of Florida/Desktop/School/PHD/01_Projects/01_FuelDynamics/02_Data/02_Fuel_Data/Seasonal_Fuel_Sampling.xlsx",
                                     sheet = "Fuel_Data")
Seasonal_Fuel_Sampling <- Seasonal_Fuel_Sampling %>%
  filter(Site %in% c("BRSF", "WSF", "Jay"))

# Seasonal Sampling Locations
Seasonal_Sampling_Locations <- read_excel("C:/Users/DrewIvory/OneDrive - University of Florida/Desktop/School/PHD/01_Projects/01_FuelDynamics/02_Data/02_Fuel_Data/Seasonal_Fuel_Sampling.xlsx",
                                          sheet = "Sites")
Seasonal_Sampling_Locations <- Seasonal_Sampling_Locations %>%
  filter(Site %in% c("BRSF", "WSF", "Jay"))

# Bag Weights
bag_weights <- read_excel("C:/Users/DrewIvory/OneDrive - University of Florida/Desktop/School/PHD/01_Projects/01_FuelDynamics/02_Data/02_Fuel_Data/Seasonal_Fuel_Sampling.xlsx",
                                          sheet = "Bag_Avg")

# Site Data
CogonSites <- read_excel("C:/Users/DrewIvory/OneDrive - University of Florida/Desktop/School/PHD/01_Projects/05_SharedData/CogonSites_FL_AL_MS.xlsx")
CogonSites <- CogonSites %>%
  filter(Site %in% c("BRSF", "WSF", "Jay"))

# Only include Florida/Alabama Sites
CogonSites <- CogonSites[CogonSites$Site != "CNF" & CogonSites$Site != "DSNF", ]

```

## Filter All data to only include specified species (Per PLANTS database)

```{r Filter_All, include=FALSE}
#Filter tree data to only include trees with "tree" in the growth column
tree_data <- dplyr::filter(tree_data, Growth == "Tree")

```

## Filter all data to only include species found at 3% of all sites
```{r RareFilter_All, include=FALSE}
# Calculate the total number of sites
total_sites <- nrow(CogonSites)

# Function to filter data by frequency
filter_by_frequency <- function(df) {
  # Group data by species and calculate the frequency
  freq <- df %>%
    group_by(Species) %>%
    summarise(Frequency = n_distinct(Plot) / nrow(CogonSites) * 100) %>%
    filter(Frequency >= 0)
  
  # Filter the original data to include only species with frequency >= 3%
  filtered_df <- df %>%
    filter(Species %in% freq$Species)
  
  return(filtered_df)
}

# Filter tree data by frequency
tree_data <- filter_by_frequency(tree_data)

```

#Fuel Dynamics
## Combine seasonal fuel data
```{r Combine_Fuel_All, include=FALSE}
# Helps deal with NAs temp
fuel_data$Net_Live <- as.numeric(fuel_data$Net_Live)
fuel_data$Net_Dead <- as.numeric(fuel_data$Net_Dead)
fuel_data$Net_Litter <- as.numeric(fuel_data$Net_Litter)

# Helps deal with NAs temp
Seasonal_Fuel_Sampling$Net_Live <- as.numeric(Seasonal_Fuel_Sampling$Net_Live)
Seasonal_Fuel_Sampling$Net_Dead <- as.numeric(Seasonal_Fuel_Sampling$Net_Dead)
Seasonal_Fuel_Sampling$Net_Litter <- as.numeric(Seasonal_Fuel_Sampling$Net_Litter)

fuel_data <- fuel_data %>% mutate(Season = "Summer")

Combined_Data <- bind_rows(fuel_data, Seasonal_Fuel_Sampling)

Combined_Data <- Combined_Data %>%
  mutate_at(vars(Soil_Moisture), as.numeric)

# Only include Florida/Alabama Data
Combined_Data <- Combined_Data[Combined_Data$Site != "CNF" & Combined_Data$Site != "DSNF", ]

## Fill in 0gs for empty quadrats and NAs for quadrats that don't exist because of too small of a patch
Combined_Data <- Combined_Data %>%
  mutate_at(vars(starts_with("Live")), 
            ~ ifelse(.x == "NO_LIVE", 0, .x)) %>%
  mutate_at(vars(starts_with("Live")), 
            ~ ifelse(.x == "SMALL_PATCH", NA, as.numeric(.x))) %>%
  mutate_at(vars(starts_with("Dead")), 
            ~ ifelse(.x == "NO_DEAD", 0, .x)) %>%
  mutate_at(vars(starts_with("Dead")), 
            ~ ifelse(.x == "SMALL_PATCH", NA, as.numeric(.x))) %>%
  mutate_at(vars(starts_with("Litter")), 
            ~ ifelse(.x == "NO_LITTER", 0, .x)) %>%
  mutate_at(vars(starts_with("Litter")), 
            ~ ifelse(.x == "SMALL_PATCH", NA, as.numeric(.x)))

Combined_Data_Avg <- Combined_Data
Combined_Data_Net <- Combined_Data

bioT = 5 # Biomass threshold for moisture
```

# Net Weight Method
## Live
```{r Net_Meth_Live}
Comb_Live_Data_Net <- Combined_Data_Net %>%
  mutate(
    Live_Bag = as.numeric(Live_Bag),
    Live_Weight_Post = as.numeric(Live_Weight_Post),
    Live_Weight_Initial = as.numeric(Live_Weight_Initial),
    Live_Height = as.numeric(Height),
    Net_Live = as.numeric(Net_Live),
    Status = as.character(Status)  # Status as a character
  )

Comb_Live_Data_Net <- Comb_Live_Data_Net %>%
  mutate(biomass = Net_Live)

Comb_Live_Data_Net <- Comb_Live_Data_Net %>%
  filter(biomass >= 0)

Comb_Live_Data_Net <- Comb_Live_Data_Net %>%
  mutate(relative_moisture_content = ifelse(biomass > bioT, ((Live_Weight_Initial - Live_Bag) - Net_Live) / Net_Live * 100, NA))

avg_live_values_Net <- Comb_Live_Data_Net %>%
  group_by(Plot, Season, Status) %>%
  summarize(avg_live_biomass = mean(biomass, na.rm = TRUE),
            avg_live_moisture_content = mean(relative_moisture_content, na.rm = TRUE),
            avg_soil_moisture = mean(Soil_Moisture, na.rm = TRUE),
            avg_height = mean(Live_Height, na.rm = TRUE) / 100,
            .groups = "drop")

```

## Dead
```{r Net_Meth_Dead}
Comb_Dead_Data_Net <- Combined_Data_Net %>%
  mutate(
    Dead_Bag = as.numeric(Dead_Bag),
    Dead_Weight_Post = as.numeric(Dead_Weight_Post),
    Dead_Weight_Initial = as.numeric(Dead_Weight_Initial),
    Net_Dead = as.numeric(Net_Dead),
    Status = as.character(Status)  # Status as a character
  )

Comb_Dead_Data_Net <- Comb_Dead_Data_Net %>%
  mutate(biomass = Net_Dead)

Comb_Dead_Data_Net <- Comb_Dead_Data_Net %>%
  filter(biomass >= 0)

Comb_Dead_Data_Net <- Comb_Dead_Data_Net %>%
  mutate(relative_moisture_content = ifelse(biomass > bioT, ((Dead_Weight_Initial - Dead_Bag) - Net_Dead) / Net_Dead * 100, NA))

avg_dead_values_Net <- Comb_Dead_Data_Net %>%
  group_by(Plot, Season, Status) %>%
  summarize(avg_dead_biomass = mean(biomass, na.rm = TRUE),
            avg_dead_moisture_content = mean(relative_moisture_content, na.rm = TRUE),
            avg_soil_moisture = mean(Soil_Moisture, na.rm = TRUE),
            .groups = "drop")
```

## Litter
```{r Net_Meth_Litter}
Comb_Litter_Data_Net <- Combined_Data_Net %>%
  mutate(
    Litter_Bag = as.numeric(Litter_Bag),
    Litter_Weight_Post = as.numeric(Litter_Weight_Post),
    Litter_Weight_Initial = as.numeric(Litter_Weight_Initial),
    Net_Litter = as.numeric(Net_Litter),
    Status = as.character(Status)  # Status as a character
  )

Comb_Litter_Data_Net <- Comb_Litter_Data_Net %>%
  mutate(biomass = Net_Litter)

Comb_Litter_Data_Net <- Comb_Litter_Data_Net %>%
  filter(biomass >= 0)

Comb_Litter_Data_Net <- Comb_Litter_Data_Net %>%
  mutate(relative_moisture_content = ifelse(biomass > bioT, ((Litter_Weight_Initial - Litter_Bag) - Net_Litter) / Net_Litter * 100, NA))

avg_litter_values_Net <- Comb_Litter_Data_Net %>%
  group_by(Plot, Season, Status) %>%
  summarize(avg_litter_biomass = mean(biomass, na.rm = TRUE),
            avg_litter_moisture_content = mean(relative_moisture_content, na.rm = TRUE),
            avg_soil_moisture = mean(Soil_Moisture, na.rm = TRUE),
            .groups = "drop")
```

# Average Bag Weight Method
## Live
```{r Avg_Meth_Live}
Comb_Live_Data_Avg <- Combined_Data_Avg %>%
  mutate(
    Live_Bag = as.numeric(Live_Bag),
    Live_Weight_Post = as.numeric(Live_Weight_Post),
    Live_Weight_Initial = as.numeric(Live_Weight_Initial),
    Live_Height = as.numeric(Height),
    Dry_LiveBag = as.numeric(Dry_LiveBag),
    Status = as.character(Status)  # Status as a character
  )

Comb_Live_Data_Avg <- Comb_Live_Data_Avg %>%
  mutate(biomass = Live_Weight_Post - Dry_LiveBag)

Comb_Live_Data_Avg <- Comb_Live_Data_Avg %>%
  filter(biomass >= 0)

Comb_Live_Data_Avg <- Comb_Live_Data_Avg %>%
  mutate(relative_moisture_content = ifelse(biomass > bioT, (Live_Weight_Initial - Live_Weight_Post) / biomass * 100, NA))

avg_live_values_Avg <- Comb_Live_Data_Avg %>%
  group_by(Plot, Season, Status) %>%
  summarize(avg_live_biomass = mean(biomass, na.rm = TRUE),
            avg_live_moisture_content = mean(relative_moisture_content, na.rm = TRUE),
            avg_soil_moisture = mean(Soil_Moisture, na.rm = TRUE),
            avg_height = mean(Live_Height, na.rm = TRUE) / 100,
            .groups = "drop")

```

## Dead
```{r Avg_Meth_Dead}
Comb_Dead_Data_Avg <- Combined_Data_Avg %>%
  mutate(
    Dead_Bag = as.numeric(Dead_Bag),
    Dead_Weight_Post = as.numeric(Dead_Weight_Post),
    Dead_Weight_Initial = as.numeric(Dead_Weight_Initial),
    Dry_DeadBag = as.numeric(Dry_DeadBag),
    Status = as.character(Status)  # Status as a character
  )

Comb_Dead_Data_Avg <- Comb_Dead_Data_Avg %>%
  mutate(biomass = Dead_Weight_Post - Dry_DeadBag)

Comb_Dead_Data_Avg <- Comb_Dead_Data_Avg %>%
  filter(biomass >= 0)

Comb_Dead_Data_Avg <- Comb_Dead_Data_Avg %>%
  mutate(relative_moisture_content = ifelse(biomass > bioT, (Dead_Weight_Initial - Dead_Weight_Post) / biomass * 100, NA))

avg_dead_values_Avg <- Comb_Dead_Data_Avg %>%
  group_by(Plot, Season, Status) %>%
  summarize(avg_dead_biomass = mean(biomass, na.rm = TRUE),
            avg_dead_moisture_content = mean(relative_moisture_content, na.rm = TRUE),
            avg_soil_moisture = mean(Soil_Moisture, na.rm = TRUE),
            .groups = "drop")

```

## Litter
```{r Avg_Meth_Litter}
Comb_Litter_Data_Avg <- Combined_Data_Avg %>%
  mutate(
    Litter_Bag = as.numeric(Litter_Bag),
    Litter_Weight_Post = as.numeric(Litter_Weight_Post),
    Litter_Weight_Initial = as.numeric(Litter_Weight_Initial),
    Dry_LitterBag = as.numeric(Dry_LitterBag),
    Status = as.character(Status)  # Status as a character
  )

Comb_Litter_Data_Avg <- Comb_Litter_Data_Avg %>%
  mutate(biomass = Litter_Weight_Post - Dry_LitterBag)

Comb_Litter_Data_Avg <- Comb_Litter_Data_Avg %>%
  filter(biomass >= 0)

Comb_Litter_Data_Avg <- Comb_Litter_Data_Avg %>%
  mutate(relative_moisture_content = ifelse(biomass > bioT, (Litter_Weight_Initial - Litter_Weight_Post) / biomass * 100, NA))

avg_litter_values_Avg <- Comb_Litter_Data_Avg %>%
  group_by(Plot, Season, Status) %>%
  summarize(avg_litter_biomass = mean(biomass, na.rm = TRUE),
            avg_litter_moisture_content = mean(relative_moisture_content, na.rm = TRUE),
            avg_soil_moisture = mean(Soil_Moisture, na.rm = TRUE),
            .groups = "drop")
```

## Fill in gaps within Net method with Avg method.
```{r Fill_Gaps}
# Live
avg_live_values_Combined <- avg_live_values_Net %>%
  full_join(avg_live_values_Avg, by = "Plot", suffix = c("_Net", "_Avg")) %>%
  mutate(
    avg_live_biomass = coalesce(avg_live_biomass_Net, avg_live_biomass_Avg),
    avg_live_moisture_content = coalesce(avg_live_moisture_content_Net, avg_live_moisture_content_Avg),
    avg_soil_moisture = coalesce(avg_soil_moisture_Net, avg_soil_moisture_Avg),
    avg_height = coalesce(avg_height_Net, avg_height_Avg),
    Season = coalesce(Season_Net, Season_Avg),
    Status = coalesce(Status_Net, Status_Avg)
  ) %>%
  select(Plot, Season, Status, avg_live_biomass, avg_live_moisture_content, avg_soil_moisture, avg_height)

# Dead
avg_dead_values_Combined <- avg_dead_values_Net %>%
  full_join(avg_dead_values_Avg, by = "Plot", suffix = c("_Net", "_Avg")) %>%
  mutate(
    avg_dead_biomass = coalesce(avg_dead_biomass_Net, avg_dead_biomass_Avg),
    avg_dead_moisture_content = coalesce(avg_dead_moisture_content_Net, avg_dead_moisture_content_Avg),
    avg_soil_moisture = coalesce(avg_soil_moisture_Net, avg_soil_moisture_Avg),
    Season = coalesce(Season_Net, Season_Avg),
    Status = coalesce(Status_Net, Status_Avg)
  ) %>%
  select(Plot, Season, Status, avg_dead_biomass, avg_dead_moisture_content, avg_soil_moisture)

# Litter
avg_litter_values_Combined <- avg_litter_values_Net %>%
  full_join(avg_litter_values_Avg, by = "Plot", suffix = c("_Net", "_Avg")) %>%
  mutate(
    avg_litter_biomass = coalesce(avg_litter_biomass_Net, avg_litter_biomass_Avg),
    avg_litter_moisture_content = coalesce(avg_litter_moisture_content_Net, avg_litter_moisture_content_Avg),
    avg_soil_moisture = coalesce(avg_soil_moisture_Net, avg_soil_moisture_Avg),
    Season = coalesce(Season_Net, Season_Avg),
    Status = coalesce(Status_Net, Status_Avg)
  ) %>%
  select(Plot, Season, Status, avg_litter_biomass, avg_litter_moisture_content, avg_soil_moisture)


```

## Combine summer sampling (CogonSites) locations with winter sampling locations
```{r Combine_Sampling_All, include=FALSE}
merged_sites <- CogonSites %>%
  full_join(Seasonal_Sampling_Locations, by = c("Plot", "Latitude", "Longitude", "Status", "BurnYear", "Site"))
```

## Merge avg_live_values, avg_dead_values, and avg_litter_values
```{r Merge_Fuel_All, include=FALSE}
avg_fuel_values <- avg_live_values_Combined %>%
  full_join(avg_dead_values_Combined, by = c("Plot", "Season", "Status")) %>%
  full_join(avg_litter_values_Combined, by = c("Plot", "Season", "Status"))

## Drop avg_soil_moisture.x and avg_soil_moisture.y
avg_fuel_values <- avg_fuel_values %>%
  select(-avg_soil_moisture.x, -avg_soil_moisture.y)

# Merge with CogonSites and merged_sites
CogonSites <- CogonSites %>%
  left_join(avg_fuel_values, by = "Plot")

merged_sites <- merged_sites %>%
  left_join(avg_fuel_values, by = "Plot")
```

## Average Fuel Values by Invasion Status and Season
There are 10,000 square meters in a hectare. Biomass is from 25 cm by 25 cm quadrats, so we have 0.0625 square meters. Therefore, 10,000/0.0625 = 160,000. So biomass gets multiplied by 160,000 and divided by 1,000,000 to convert from grams to tonnes.

## 25th, 50th and 75 quantiles of fuel values
```{r Fuel_Quant_All, echo=TRUE}
Fuel_model_quantiles <- avg_fuel_values %>%
  group_by(Status, Season) %>%
  summarize(avg_live_biomass_25 = quantile(avg_live_biomass, 0.25, na.rm = TRUE) * 0.16,
            avg_live_biomass_50 = quantile(avg_live_biomass, 0.50, na.rm = TRUE) * 0.16,
            avg_live_biomass_75 = quantile(avg_live_biomass, 0.75, na.rm = TRUE) * 0.16,
            avg_dead_biomass_25 = quantile(avg_dead_biomass, 0.25, na.rm = TRUE) * 0.16,
            avg_dead_biomass_50 = quantile(avg_dead_biomass, 0.50, na.rm = TRUE) * 0.16,
            avg_dead_biomass_75 = quantile(avg_dead_biomass, 0.75, na.rm = TRUE) * 0.16,
            avg_litter_biomass_25 = quantile(avg_litter_biomass, 0.25, na.rm = TRUE) * 0.16,
            avg_litter_biomass_50 = quantile(avg_litter_biomass, 0.50, na.rm = TRUE) * 0.16,
            avg_litter_biomass_75 = quantile(avg_litter_biomass, 0.75, na.rm = TRUE) * 0.16,
            avg_live_moisture_content_25 = quantile(avg_live_moisture_content, 0.25, na.rm = TRUE),
            avg_live_moisture_content_50 = quantile(avg_live_moisture_content, 0.50, na.rm = TRUE),
            avg_live_moisture_content_75 = quantile(avg_live_moisture_content, 0.75, na.rm = TRUE),
            avg_dead_moisture_content_25 = quantile(avg_dead_moisture_content, 0.25, na.rm = TRUE),
            avg_dead_moisture_content_50 = quantile(avg_dead_moisture_content, 0.50, na.rm = TRUE),
            avg_dead_moisture_content_75 = quantile(avg_dead_moisture_content, 0.75, na.rm = TRUE),
            avg_litter_moisture_content_25 = quantile(avg_litter_moisture_content, 0.25, na.rm = TRUE),
            avg_litter_moisture_content_50 = quantile(avg_litter_moisture_content, 0.50, na.rm = TRUE),
            avg_litter_moisture_content_75 = quantile(avg_litter_moisture_content, 0.75, na.rm = TRUE),
            avg_soil_moisture_25 = quantile(avg_soil_moisture, 0.25, na.rm = TRUE),
            avg_soil_moisture_50 = quantile(avg_soil_moisture, 0.50, na.rm = TRUE),
            avg_soil_moisture_75 = quantile(avg_soil_moisture, 0.75, na.rm = TRUE),
            avg_height_25 = quantile(avg_height, 0.25, na.rm = TRUE),
            avg_height_50 = quantile(avg_height, 0.50, na.rm = TRUE),
            avg_height_75 = quantile(avg_height, 0.75, na.rm = TRUE),
            .groups = "drop")

# Kable table of quantiles
kable(Fuel_model_quantiles)
```

## Fuel Table
```{r Fuel_Table, echo=FALSE}
# Round for clarity
Fuel_model_quantiles_clean <- Fuel_model_quantiles %>%
  mutate(across(where(is.numeric), ~ round(.x, 2)))

Fuel_model_quantiles_clean <- Fuel_model_quantiles_clean %>%
  mutate(Season = dplyr::recode(Season, "Green_Up" = "Spring"))

# 1. Pivot longer
Fuel_model_long <- Fuel_model_quantiles_clean %>%
  pivot_longer(
    cols = -c(Status, Season),
    names_to = "Variable",
    values_to = "Value"
  )

# 2. Create Status-Season group for columns
Fuel_model_long <- Fuel_model_long %>%
  mutate(Status_Season = paste(Status, Season, sep = " - ")) %>%
  select(Status_Season, Variable, Value)

# 3. Pivot wider: variables in rows, Status-Season in columns
Fuel_model_wide <- Fuel_model_long %>%
  pivot_wider(
    names_from = Status_Season,
    values_from = Value
  )

# 4. Clean variable names for display
Fuel_model_wide <- Fuel_model_wide %>%
  mutate(Variable = Variable %>%
           str_replace_all("avg_", "") %>%
           str_replace_all("_biomass", " Biomass") %>%
           str_replace_all("_moisture_content", " Moisture Content") %>%
           str_replace_all("_soil_moisture", "Soil Moisture") %>%
           str_replace_all("_height", "Vegetation Height") %>%
           str_replace("25$", "(25%)") %>%
           str_replace("50$", "(50%)") %>%
           str_replace("75$", "(75%)") %>%
           str_replace_all("_", " ") %>%
           str_to_title()
         )

# 5. Format using gt
Fuel_model_wide %>%
  gt() %>%
  tab_header(title = "Fuel and Moisture Quantiles by Invasion Status and Season") %>%
  fmt_number(
    columns = where(is.numeric),
    decimals = 2
  ) %>%
  cols_label_with(fn = function(col) str_replace_all(col, "_", " ")) %>%
  tab_options(
    table.width = pct(100),
    data_row.padding = px(4)
  )


fuel_gt_table <- Fuel_model_wide %>%
  gt() %>%
  tab_header(title = "Fuel and Moisture Quantiles by Invasion Status and Season") %>%
  fmt_number(
    columns = where(is.numeric),
    decimals = 2
  ) %>%
  cols_label_with(fn = function(col) str_replace_all(col, "_", " ")) %>%
  tab_options(
    table.width = pct(100),
    data_row.padding = px(4)
  )

# View the table
print(fuel_gt_table)

# Save to Word document
gtsave(fuel_gt_table, "Fuel_Characteristics_quantiles.rtf")


```

# Objective 1- Cogongrass relationship with fuel dynamics
# Data Cleaning
```{r Data_Cleaning, include=FALSE}
merged_sites <- merged_sites %>%
  dplyr::select(-Camera, -SoilType, -Muname, -NLCD_LandCover, -Status.y)

merged_sites <- merged_sites %>%
  mutate(Season = dplyr::recode(Season, "Green_Up" = "Spring"))

colnames(merged_sites)[colnames(merged_sites) == "Status.x"] <- "Status"
merged_sites$Status <- relevel(factor(merged_sites$Status), ref = "Non_Invaded")
merged_sites$Season <- relevel(factor(merged_sites$Season), ref = "Summer")
merged_sites$Site <- relevel(factor(merged_sites$Site), ref = "Jay")

# Multiply live, dead, and litter biomass by 0.16
merged_sites <- merged_sites %>%
  mutate(avg_live_biomass = avg_live_biomass * 0.16,
         avg_dead_biomass = avg_dead_biomass * 0.16,
         avg_litter_biomass = avg_litter_biomass * 0.16)

merged_sites <- merged_sites %>%
  mutate(avg_live_biomass = ifelse(is.na(avg_live_biomass), 0, avg_live_biomass),
         avg_dead_biomass = ifelse(is.na(avg_dead_biomass), 0, avg_dead_biomass),
         avg_litter_biomass = ifelse(is.na(avg_litter_biomass), 0, avg_litter_biomass))
```


## GLMM Live Fuel Biomass
```{r GLMM_Live_Fuel_Biomass, include=FALSE}

LV_Bio_model_student <- brm(avg_live_biomass ~
                            Status * Season +
                            Status * Latitude +
                             (1 | Site),
                            data = merged_sites,
                           family = student(),
                           chains = 4,
                           iter = 4000,
                           warmup = 1000,
                           control = list(adapt_delta = 0.95)
                           )

```

## Model Comparison
```{r compare_LV_Bio, echo=FALSE}
# Compare models with Leave-One-Out Cross-Validation
loo_student_LV_Bio <- loo(LV_Bio_model_student)


summary(LV_Bio_model_student)

# Plot the posterior predictive checks
pp_check(LV_Bio_model_student) +
  labs(title = "Posterior Predictive Check for Live Biomass Model") +
  theme_minimal()


# Plot the relationship between invasion status and surface rate of spread
merged_sites %>%
  ggplot(aes(x = Status, y = avg_live_biomass)) +
  geom_point(aes(color = Season),
             position = position_jitterdodge(jitter.width = 0.15, dodge.width = 0.7),
             alpha = 0.3, size = 2) +
  geom_boxplot(aes(fill = Season),
               position = position_dodge(width = 0.7),
               width = 0.6, outlier.shape = NA, alpha = 0.3) +
  labs(x = "Invasion Status",
       y = "Live Biomass (tonne/ha)",
       color = "Season", fill = "Season") +
  theme_minimal()

pad <- diff(range(merged_sites$avg_live_biomass, na.rm = TRUE)) * 0.05
spr_y <- max(merged_sites$avg_live_biomass[merged_sites$Season == "Spring"], na.rm = TRUE) + pad
win_y <- max(merged_sites$avg_live_biomass[merged_sites$Season == "Winter"], na.rm = TRUE) + pad

ann <- data.frame(
  Season = c("Spring", "Winter"),
  x = 1, xend = 2,
  y = c(spr_y, win_y)
)

merged_sites %>%
  ggplot(aes(x = Status, y = avg_live_biomass)) +
  geom_point(aes(color = Season),
             position = position_jitterdodge(jitter.width = 0.15, dodge.width = 0.7),
             alpha = 0.3, size = 2) +
  geom_boxplot(aes(fill = Season),
               position = position_dodge(width = 0.7),
               width = 0.6, outlier.shape = NA, alpha = 0.3) +
  facet_wrap(~ Season, nrow = 1) +
  geom_segment(data = ann, aes(x = x, xend = xend, y = y, yend = y), inherit.aes = FALSE) +
  geom_text(data = transform(ann, x = 1.5, y = y + pad/2, label = "*"),
            aes(x = x, y = y, label = label), inherit.aes = FALSE, size = 6) +
  labs(x = "Invasion Status",
       y = "Live Biomass (tonne/ha)",
       color = "Season", fill = "Season") +
  theme_minimal()
```


## Estimated marginal means
```{r emmeans_Live_Biomass, echo=FALSE}
emm_results <- emmeans(LV_Bio_model_student, specs = ~ Status | Season)


pairwise_comparisons <- pairs(emm_results, reverse = TRUE)

print(pairwise_comparisons)

# exact posterior probability
exact_pp <- p_direction(pairwise_comparisons)

print(exact_pp)

# Convert pairwise comparisons to data frame
pairwise_df <- as.data.frame(pairwise_comparisons) %>%
  mutate(
    # Add exact posterior probability from p_direction
    p_direction = exact_pp
  )

# Make the gt table
pairwise_gt_table <- pairwise_df %>%
  select(Season, contrast, estimate, lower.HPD, upper.HPD, p_direction) %>%
  gt() %>%
  fmt_number(
    columns = c(estimate, lower.HPD, upper.HPD),
    decimals = 2
  ) %>%
  fmt_number(
    columns = "p_direction",
    decimals = 2
  ) %>%
  tab_header(
    title = "Pairwise Comparisons of Live Biomass by Invasion Status within Season"
  ) %>%
  cols_label(
    Season = "Season",
    contrast = "Contrast",
    estimate = "Difference (tonne/ha)",
    lower.HPD = "95% HPD Lower",
    upper.HPD = "95% HPD Upper",
    p_direction = "Posterior Prob."
  )

print(pairwise_gt_table)

# Save as RTF
gtsave(
  pairwise_gt_table,
  "C:/Users/DrewIvory/OneDrive - University of Florida/Desktop/School/PHD/01_Projects/01_FuelDynamics/02_Data/Posterior_Probabilities/LiveB_Pairwise_Table.rtf"
)

```


## Live Biomass Summary Table
```{r Live_Biomass_Summary, echo=FALSE}


# Rhat values from the fitted model
rhat_values_df <- enframe(
  brms::rhat(LV_Bio_model_student),
  name = "Parameter_raw",
  value = "Rhat"
)

LiveB_summary_df <- as_draws_df(LV_Bio_model_student) %>%
  select(starts_with("b_")) %>%
  pivot_longer(
    cols      = everything(),
    names_to  = "Parameter_raw",
    values_to = "Value"
  ) %>%
  group_by(Parameter_raw) %>%
  summarise(
    Estimate        = median(Value),
    `Est. Error`    = mad(Value),
    `95% HPDI (Lower)` = hdi(Value, ci = 0.95)$CI_low,
    `95% HPDI (Upper)` = hdi(Value, ci = 0.95)$CI_high,
    `Pd` = max(mean(Value > 0), mean(Value < 0)),
    `Bulk ESS`        = posterior::ess_bulk(Value),
    `Tail ESS`        = posterior::ess_tail(Value),
    `R-hat`           = posterior::rhat(Value),
    .groups = "drop"
  ) %>%
  mutate(
    Parameter = gsub("b_", "", Parameter_raw),
    Parameter = gsub("StatusInvaded", "Status-Invaded", Parameter),
    Parameter = gsub("SeasonSpring", "Season-Spring", Parameter),
    Parameter = gsub("SeasonWinter", "Season-Winter", Parameter),
    Parameter = gsub("Latitude", "Latitude", Parameter),
    Parameter = gsub(":", " x ", Parameter),
    Parameter = if_else(Parameter == "Intercept", "(Intercept)", Parameter)
  )

LiveB_gt_table <- LiveB_summary_df %>%
  mutate(Significant = Pd >= 0.95) %>%
  select(
    Parameter,
    Estimate,
    `Est. Error`,
    `95% HPDI (Lower)`,
    `95% HPDI (Upper)`,
    `Pd`,
    `Bulk ESS`,
    `Tail ESS`,
    `R-hat`,
    Significant
  ) %>%
  gt(rowname_col = "Parameter") %>%
  fmt_number(
    columns = c("Estimate", "Est. Error", "95% HPDI (Lower)", "95% HPDI (Upper)"),
    decimals = 2
  ) %>%
  fmt_number(columns = "Pd", decimals = 3) %>%
  fmt_number(columns = "R-hat", decimals = 3) %>%
  fmt_number(columns = c("Bulk ESS", "Tail ESS"), decimals = 0, use_seps = TRUE) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(rows = Significant == TRUE)
  ) %>%
  cols_hide(columns = "Significant") %>%
  tab_header(title = "Posterior Estimates for Live Biomass")

print(LiveB_gt_table)

gtsave(
  LiveB_gt_table,
  "C:/Users/DrewIvory/OneDrive - University of Florida/Desktop/School/PHD/01_Projects/01_FuelDynamics/02_Data/Posterior_Probabilities/LiveB_Posterior_Table.rtf"
)


```


## Conditional Effects Live Biomass
```{r Conditional_Effects_Live_Biomass, echo=FALSE}
# Plot the conditional effects
#conditional_effects(LV_Bio_model_student) %>%
#  plot() +
#  labs(title = "Conditional Effects of Live Biomass Model") +
#  theme_minimal()


liveB_ce_status_season <- conditional_effects(LV_Bio_model_student, effects = "Status:Season")
liveB_df <- liveB_ce_status_season[["Status:Season"]]

liveB_df$Status <- factor(liveB_df$Status,
                    levels = c("Non_Invaded", "Invaded"),
                    labels = c("Non-Invaded", "Invaded"))

ggplot(liveB_df, aes(x = Season, y = estimate__, group = Season, color = Season)) +
  geom_point(position = position_dodge(width = 0.5), size = 3) +
  geom_errorbar(aes(ymin = lower__, ymax = upper__), 
                width = 0.2, position = position_dodge(width = 0.5)) +
  geom_line(position = position_dodge(width = 0.5)) +
  facet_wrap(~Status) +
  labs(
    # title = "Estimated Live Biomass by Season and Invasion Status",  # Removed
    x = "Season",
    y = expression("Live Biomass (" * t %.% ha^{-1} * ")"),
    color = "Season"
  ) +
  scale_color_manual(values = c("Spring" = "#1b9e77", "Summer" = "#d95f02", "Winter" = "#7570b3")) +
  scale_y_continuous(limits = c(0, NA), expand = expansion(mult = c(0, 0.45))) +
  theme_minimal(base_size = 16) +
  theme(
    panel.grid.major.x = element_blank(),      # Remove major vertical grid lines
    panel.grid.minor = element_blank(),        # Remove all minor grid lines
    panel.grid.major.y = element_line(color = "gray80", size = 0.5),  # Keep major horizontal grid lines
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 14),
    strip.text = element_text(size = 16),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    legend.position = "top"
    )


ce_lat_status <- conditional_effects(LV_Bio_model_student, effects = "Latitude:Status")

plot_data <- ce_lat_status[["Latitude:Status"]]
custom_colors <- c("Invaded" = "#0072B2", "Non_Invaded" = "#D55E00")

ggplot() +
  geom_ribbon(
    data = plot_data,
    aes(x = Latitude, ymin = lower__, ymax = upper__, fill = Status),
    alpha = 0.2
  ) +
  geom_line(
    data = plot_data,
    aes(x = Latitude, y = estimate__, color = Status),
    linewidth = 1
  ) +
  geom_point(
    data = merged_sites, 
    aes(x = Latitude, y = avg_live_biomass, color = Status), 
    alpha = 0.5 
  ) +
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  labs(
    x = "Latitude (\u00B0)",
    y = "Live Fuel Load (t/ha)"
  ) +
  scale_y_continuous(
  breaks = seq(0, 11, by = 2)
  ) +
  coord_cartesian(ylim = c(0, 11)) +
  theme_minimal(base_size = 12) +
  theme(
    legend.position = c(0.98, 0.98),
    legend.justification = c("right", "top"),
    legend.background = element_rect(
      fill = alpha("white", 0.8),
      color = "grey70"
    ),
    legend.key = element_blank(),
    legend.title = element_blank()
  ) +
  guides(fill = "none")


```


## Conditional Effects Live Biomass
```{r Conditional_Effects_Live_Biomass_O, eval=FALSE, include=FALSE}
eff <- conditional_effects(LV_Bio_model_student)

for (effect_name in names(eff)) {
  eff_df <- as.data.frame(eff[[effect_name]])
  
  main_var <- names(eff_df)[1]
  
  p <- ggplot(eff_df, aes_string(x = main_var, y = "estimate__")) + 
    geom_point() + 
    geom_errorbar(aes_string(ymin = "lower__", ymax = "upper__")) + 
    labs(title = paste("Effect of", effect_name))
  
  print(p)
}

```


## GLMM Dead Fuel Biomass
```{r GLMM_Dead_Fuel_Biomass, include=FALSE}

D_Bio_model_student <- brm(avg_dead_biomass ~
                            Status * Season +
                            Status * Latitude +
                             (1 | Site),
                            data = merged_sites,
                           family = student(),
                           chains = 4,
                           iter = 4000,
                           warmup = 1000,
                           control = list(adapt_delta = 0.95)
                           )

D_Bio_model_nonI <- brm(avg_dead_biomass ~
                            Status + Season +
                            Latitude +
                             (1 | Site),
                            data = merged_sites,
                           family = student(),
                           chains = 4,
                           iter = 4000,
                           warmup = 1000,
                           control = list(adapt_delta = 0.95)
                           )

```

## Model Comparison
```{r compare_D_Bio, echo=FALSE}
# Compare models with Leave-One-Out Cross-Validation
loo_student_D_Bio <- loo(D_Bio_model_student)


summary(D_Bio_model_student)
summary(D_Bio_model_nonI)

# Plot the posterior predictive checks
pp_check(D_Bio_model_student) +
  labs(title = "Posterior Predictive Check for Dead Biomass Model") +
  theme_minimal()

## Rearrange "High", "Mean", "Low" to "Low", "Mean", "High"

# Plot the conditional effects
#conditional_effects(D_Bio_model_student) %>%
#  plot() +
#  labs(title = "Conditional Effects of Dead Biomass Model") +
#  theme_minimal()

# Plot the relationship between invasion status and surface rate of spread
merged_sites %>%
  ggplot(aes(x = Status, y = avg_dead_biomass, color = Season)) +
  geom_boxplot() +
  geom_jitter(width = 0.2, alpha = 0.2) +
  labs(title = "Dead Biomass by Invasion Status and Season",
       x = "Invasion Status",
       y = "Dead Biomass (tonne/ha)",
       color = "Season") +
  theme_minimal()

merged_sites %>%
  ggplot(aes(x = Status, y = avg_dead_biomass, color = Status)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.2, alpha = 0.2) +
  scale_color_manual(values = c("Non_Invaded" = "#228B22", "Invaded" = "coral")) +
  labs(x = "Invasion Status",
       y = expression("Dead Fuel Load (t ha"^{-1}*")")) +
  theme_minimal() +
  theme(legend.position = "none")
```

## Estimated marginal means
```{r emmeans_Dead_Biomass, echo=FALSE}
emm_results <- emmeans(D_Bio_model_student, specs = ~ Status | Season)


pairwise_comparisons <- pairs(emm_results, reverse = TRUE)

print(pairwise_comparisons)

# exact posterior probability
exact_pp <- p_direction(pairwise_comparisons)

print(exact_pp)

emm_results_nonI <- emmeans(D_Bio_model_nonI, specs = ~ Status)
pairwise_comparisons_nonI <- pairs(emm_results_nonI, reverse = TRUE)

# Convert to data frame
pw_df <- as.data.frame(pairwise_comparisons_nonI)

# Create gt table
pw_gt <- pw_df %>%
  gt() %>%
  fmt_number(
    columns = where(is.numeric),
    decimals = 3
  ) %>%
  tab_header(
    title = "Pairwise Comparisons of Status"
  )

# Save as RTF
gtsave(
  pw_gt,
  filename = "C:/Users/DrewIvory/OneDrive - University of Florida/Desktop/School/PHD/01_Projects/01_FuelDynamics/02_Data/Posterior_Probabilities/DeadB_pairwise_comparisons_nonI.rtf")




emm_results_nonI_season <- emmeans(D_Bio_model_nonI, specs = ~ Season)
pairwise_comparisons_nonI_season <- pairs(emm_results_nonI_season, reverse = TRUE)
print(pairwise_comparisons_nonI_season)

```

## Dead Biomass Summary Table
```{r Dead_Biomass_Summary, echo=FALSE}
# ---- Summarize posterior draws ----
rhat_values_df <- enframe(
  brms::rhat(D_Bio_model_student),
  name = "Parameter_raw",
  value = "Rhat"
)

DeadB_summary_df <- as_draws_df(D_Bio_model_student) %>%
  select(starts_with("b_")) %>%
  pivot_longer(
    cols      = everything(),
    names_to  = "Parameter_raw",
    values_to = "Value"
  ) %>%
  group_by(Parameter_raw) %>%
  summarise(
    Estimate        = median(Value),
    `Est. Error`    = mad(Value),
    `95% HPDI (Lower)` = hdi(Value, ci = 0.95)$CI_low,
    `95% HPDI (Upper)` = hdi(Value, ci = 0.95)$CI_high,
    `Pd` = max(mean(Value > 0), mean(Value < 0)),
    `Bulk ESS`        = posterior::ess_bulk(Value),
    `Tail ESS`        = posterior::ess_tail(Value),
    `R-hat`           = posterior::rhat(Value),
    .groups = "drop"
  ) %>%
  mutate(
    Parameter = gsub("b_", "", Parameter_raw),
    Parameter = gsub("StatusInvaded", "Status-Invaded", Parameter),
    Parameter = gsub("SeasonSpring", "Season-Spring", Parameter),
    Parameter = gsub("SeasonWinter", "Season-Winter", Parameter),
    Parameter = gsub("Latitude", "Latitude", Parameter),
    Parameter = gsub(":", " x ", Parameter),
    Parameter = if_else(Parameter == "Intercept", "(Intercept)", Parameter)
  )

DeadB_gt_table <- DeadB_summary_df %>%
  mutate(Significant = Pd >= 0.95) %>%
  select(
    Parameter,
    Estimate,
    `Est. Error`,
    `95% HPDI (Lower)`,
    `95% HPDI (Upper)`,
    `Pd`,
    `Bulk ESS`,
    `Tail ESS`,
    `R-hat`,
    Significant
  ) %>%
  gt(rowname_col = "Parameter") %>%
  fmt_number(
    columns = c("Estimate", "Est. Error", "95% HPDI (Lower)", "95% HPDI (Upper)"),
    decimals = 2
  ) %>%
  fmt_number(columns = "Pd", decimals = 3) %>%
  fmt_number(columns = "R-hat", decimals = 3) %>%
  fmt_number(columns = c("Bulk ESS", "Tail ESS"), decimals = 0, use_seps = TRUE) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(rows = Significant == TRUE)
  ) %>%
  cols_hide(columns = "Significant") %>%
  tab_header(title = "Posterior Estimates for Dead Biomass")

print(DeadB_gt_table)

gtsave(
  DeadB_gt_table,
  "C:/Users/DrewIvory/OneDrive - University of Florida/Desktop/School/PHD/01_Projects/01_FuelDynamics/02_Data/Posterior_Probabilities/DeadB_Posterior_Table.rtf"
)



```

## Dead Biomass Summary Table- NonI
```{r Dead_Biomass_Summary_NonI, echo=FALSE}
# ---- Summarize posterior draws ----
rhat_values_df <- enframe(
  brms::rhat(D_Bio_model_nonI),
  name = "Parameter_raw",
  value = "Rhat"
)

DeadB_summary_df_nonI <- as_draws_df(D_Bio_model_nonI) %>%
  select(starts_with("b_")) %>%
  pivot_longer(
    cols      = everything(),
    names_to  = "Parameter_raw",
    values_to = "Value"
  ) %>%
  group_by(Parameter_raw) %>%
  summarise(
    Estimate        = median(Value),
    `Est. Error`    = mad(Value),
    `95% HPDI (Lower)` = hdi(Value, ci = 0.95)$CI_low,
    `95% HPDI (Upper)` = hdi(Value, ci = 0.95)$CI_high,
    `Pd` = max(mean(Value > 0), mean(Value < 0)),
    `Bulk ESS`        = posterior::ess_bulk(Value),
    `Tail ESS`        = posterior::ess_tail(Value),
    `R-hat`           = posterior::rhat(Value),
    .groups = "drop"
  ) %>%
  mutate(
    Parameter = gsub("b_", "", Parameter_raw),
    Parameter = gsub("StatusInvaded", "Status-Invaded", Parameter),
    Parameter = gsub("SeasonSpring", "Season-Spring", Parameter),
    Parameter = gsub("SeasonWinter", "Season-Winter", Parameter),
    Parameter = gsub("Latitude", "Latitude", Parameter),
    Parameter = if_else(Parameter == "Intercept", "(Intercept)", Parameter)
  )

DeadB_gt_table_nonI <- DeadB_summary_df_nonI %>%
  mutate(Significant = Pd >= 0.95) %>%
  select(
    Parameter,
    Estimate,
    `Est. Error`,
    `95% HPDI (Lower)`,
    `95% HPDI (Upper)`,
    `Pd`,
    `Bulk ESS`,
    `Tail ESS`,
    `R-hat`,
    Significant
  ) %>%
  gt(rowname_col = "Parameter") %>%
  fmt_number(
    columns = c("Estimate", "Est. Error", "95% HPDI (Lower)", "95% HPDI (Upper)"),
    decimals = 2
  ) %>%
  fmt_number(columns = "Pd", decimals = 3) %>%
  fmt_number(columns = "R-hat", decimals = 3) %>%
  fmt_number(columns = c("Bulk ESS", "Tail ESS"), decimals = 0, use_seps = TRUE) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(rows = Significant == TRUE)
  ) %>%
  cols_hide(columns = "Significant") %>%
  tab_header(title = "Posterior Estimates for Dead Biomass (Non-Interaction Model)")

print(DeadB_gt_table_nonI)

gtsave(
  DeadB_gt_table_nonI,
  "C:/Users/DrewIvory/OneDrive - University of Florida/Desktop/School/PHD/01_Projects/01_FuelDynamics/02_Data/Posterior_Probabilities/DeadB_Posterior_NonI_Table.rtf"
)
```


## Conditional Effects Dead Biomass
```{r Conditional_Effects_Dead_Biomass, echo=FALSE}
# Plot the conditional effects
#conditional_effects(D_Bio_model_student) %>%
#  plot() +
#  labs(title = "Conditional Effects of Dead Biomass Model") +
#  theme_minimal()

deadB_ce_status_season <- conditional_effects(D_Bio_model_student, effects = "Status:Season")
deadB_df <- deadB_ce_status_season[["Status:Season"]]

deadB_df$Status <- factor(deadB_df$Status,
                    levels = c("Non_Invaded", "Invaded"),
                    labels = c("Non-Invaded", "Invaded"))

ggplot(deadB_df, aes(x = Season, y = estimate__, group = Season, color = Season)) +
  geom_point(position = position_dodge(width = 0.5), size = 3) +
  geom_errorbar(aes(ymin = lower__, ymax = upper__), 
                width = 0.2, position = position_dodge(width = 0.5)) +
  geom_line(position = position_dodge(width = 0.5)) +
  facet_wrap(~Status) +
  labs(
    # title = "Estimated Dead Biomass by Season and Invasion Status",  # Removed
    x = "Season",
    y = expression("Dead Biomass (" * t %.% ha^{-1} * ")"),
    color = "Season"
  ) +
  scale_color_manual(values = c("Spring" = "#1b9e77", "Summer" = "#d95f02", "Winter" = "#7570b3")) +
  scale_y_continuous(limits = c(0, NA), expand = expansion(mult = c(0, 0.25))) +
  theme_minimal(base_size = 16) +
  theme(
    panel.grid.major.x = element_blank(),      # Remove major vertical grid lines
    panel.grid.minor = element_blank(),        # Remove all minor grid lines
    panel.grid.major.y = element_line(color = "gray80", size = 0.5),  # Keep major horizontal grid lines
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 14),
    strip.text = element_text(size = 16),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    legend.position = "top"
    )


```


## GLMM Litter Fuel Biomass
```{r GLMM_Litter_Fuel_Biomass, include=FALSE}

LT_Bio_model_student <- brm(avg_litter_biomass ~
                            Status * Season +
                            Status * Latitude +
                             (1 | Site),
                            data = merged_sites,
                           family = student(),
                           chains = 4,
                           iter = 4000,
                           warmup = 1000,
                           control = list(adapt_delta = 0.95)
                           )

LT_Bio_model_nonI <- brm(avg_litter_biomass ~
                            Status + Season +
                            Latitude +
                             (1 | Site),
                            data = merged_sites,
                           family = student(),
                           chains = 4,
                           iter = 4000,
                           warmup = 1000,
                           control = list(adapt_delta = 0.95)
                           )

```

## Model Comparison
```{r compare_LT_Bio, echo=FALSE}
# Compare models with Leave-One-Out Cross-Validation
loo_student_LT_Bio <- loo(LT_Bio_model_student)

summary(LT_Bio_model_student)
summary(LT_Bio_model_nonI)

# Plot the posterior predictive checks
pp_check(LT_Bio_model_student) +
  labs(title = "Posterior Predictive Check for Litter Biomass Model") +
  theme_minimal()

# Plot the relationship between invasion status and surface rate of spread
merged_sites %>%
  ggplot(aes(x = Status, y = avg_litter_biomass, color = Season)) +
  geom_boxplot() +
  geom_jitter(width = 0.2, alpha = 0.2) +
  labs(title = "Litter Biomass by Invasion Status and Season",
       x = "Invasion Status",
       y = "Litter Biomass (tonne/ha)",
       color = "Season") +
  theme_minimal()

merged_sites %>%
  ggplot(aes(x = Season, y = avg_litter_biomass, color = Season)) +
  geom_boxplot() +
  geom_jitter(width = 0.2, alpha = 0.2) +
  labs(title = "",
       x = "Season",
       y = "Litter Biomass (tonne/ha)",
       color = "Season") +
  theme_minimal()
```

## Estimated marginal means
```{r emmeans_Litter_Biomass, echo=FALSE}
emm_results <- emmeans(LT_Bio_model_student, specs = ~ Status | Season)


pairwise_comparisons <- pairs(emm_results, reverse = TRUE)

print(pairwise_comparisons)

# exact posterior probability
exact_pp <- p_direction(pairwise_comparisons)

print(exact_pp)


emm_results_nonI <- emmeans(LT_Bio_model_nonI, specs = ~ Season)
pairwise_comparisons_nonI <- pairs(emm_results_nonI, reverse = TRUE)

# Convert to data frame
pw_df <- as.data.frame(pairwise_comparisons_nonI)

# Create gt table
pw_gt <- pw_df %>%
  gt() %>%
  fmt_number(
    columns = where(is.numeric),
    decimals = 3
  ) %>%
  tab_header(
    title = "Pairwise Comparisons of Season"
  )

# Save as RTF
gtsave(
  pw_gt,
  filename = "C:/Users/DrewIvory/OneDrive - University of Florida/Desktop/School/PHD/01_Projects/01_FuelDynamics/02_Data/Posterior_Probabilities/LTB_pairwise_comparisons_nonI.rtf"
)
```

## Litter Biomass Summary Table
```{r Litter_Biomass_Summary, echo=FALSE}
# ---- Summarize posterior draws ----
rhat_values_df <- enframe(
  brms::rhat(LT_Bio_model_student),
  name = "Parameter_raw",
  value = "Rhat"
)

LitterB_summary_df <- as_draws_df(LT_Bio_model_student) %>%
  select(starts_with("b_")) %>%
  pivot_longer(
    cols      = everything(),
    names_to  = "Parameter_raw",
    values_to = "Value"
  ) %>%
  group_by(Parameter_raw) %>%
  summarise(
    Estimate        = median(Value),
    `Est. Error`    = mad(Value),
    `95% HPDI (Lower)` = hdi(Value, ci = 0.95)$CI_low,
    `95% HPDI (Upper)` = hdi(Value, ci = 0.95)$CI_high,
    `Pd` = max(mean(Value > 0), mean(Value < 0)),
    `Bulk ESS`        = posterior::ess_bulk(Value),
    `Tail ESS`        = posterior::ess_tail(Value),
    `R-hat`           = posterior::rhat(Value),
    .groups = "drop"
  ) %>%
  mutate(
    Parameter = gsub("b_", "", Parameter_raw),
    Parameter = gsub("StatusInvaded", "Status-Invaded", Parameter),
    Parameter = gsub("SeasonSpring", "Season-Spring", Parameter),
    Parameter = gsub("SeasonWinter", "Season-Winter", Parameter),
    Parameter = gsub("Latitude", "Latitude", Parameter),
    Parameter = gsub(":", " x ", Parameter),
    Parameter = if_else(Parameter == "Intercept", "(Intercept)", Parameter)
  )

LitterB_gt_table <- LitterB_summary_df %>%
  mutate(Significant = Pd >= 0.95) %>%
  select(
    Parameter,
    Estimate,
    `Est. Error`,
    `95% HPDI (Lower)`,
    `95% HPDI (Upper)`,
    `Pd`,
    `Bulk ESS`,
    `Tail ESS`,
    `R-hat`,
    Significant
  ) %>%
  gt(rowname_col = "Parameter") %>%
  fmt_number(
    columns = c("Estimate", "Est. Error", "95% HPDI (Lower)", "95% HPDI (Upper)"),
    decimals = 2
  ) %>%
  fmt_number(columns = "Pd", decimals = 3) %>%
  fmt_number(columns = "R-hat", decimals = 3) %>%
  fmt_number(columns = c("Bulk ESS", "Tail ESS"), decimals = 0, use_seps = TRUE) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(rows = Significant == TRUE)
  ) %>%
  cols_hide(columns = "Significant") %>%
  tab_header(title = "Posterior Estimates for Litter Biomass")

print(LitterB_gt_table)

gtsave(
  LitterB_gt_table,
  "C:/Users/DrewIvory/OneDrive - University of Florida/Desktop/School/PHD/01_Projects/01_FuelDynamics/02_Data/Posterior_Probabilities/LitterB_Posterior_Table.rtf"
)



```

## Litter Biomass Summary Table- NonI
```{r Litter_Biomass_Summary_NonI, echo=FALSE}
# ---- Summarize posterior draws ----
rhat_values_df <- enframe(
  brms::rhat(LT_Bio_model_nonI),
  name = "Parameter_raw",
  value = "Rhat"
)

LitterB_summary_df_nonI <- as_draws_df(LT_Bio_model_nonI) %>%
  select(starts_with("b_")) %>%
  pivot_longer(
    cols      = everything(),
    names_to  = "Parameter_raw",
    values_to = "Value"
  ) %>%
  group_by(Parameter_raw) %>%
  summarise(
    Estimate        = median(Value),
    `Est. Error`    = mad(Value),
    `95% HPDI (Lower)` = hdi(Value, ci = 0.95)$CI_low,
    `95% HPDI (Upper)` = hdi(Value, ci = 0.95)$CI_high,
    `Pd` = max(mean(Value > 0), mean(Value < 0)),
    `Bulk ESS`        = posterior::ess_bulk(Value),
    `Tail ESS`        = posterior::ess_tail(Value),
    `R-hat`           = posterior::rhat(Value),
    .groups = "drop"
  ) %>%
  mutate(
    Parameter = gsub("b_", "", Parameter_raw),
    Parameter = gsub("StatusInvaded", "Status-Invaded", Parameter),
    Parameter = gsub("SeasonSpring", "Season-Spring", Parameter),
    Parameter = gsub("SeasonWinter", "Season-Winter", Parameter),
    Parameter = gsub("Latitude", "Latitude", Parameter),
    Parameter = if_else(Parameter == "Intercept", "(Intercept)", Parameter)
  )

LitterB_gt_table_nonI <- LitterB_summary_df_nonI %>%
  mutate(Significant = Pd >= 0.95) %>%
  select(
    Parameter,
    Estimate,
    `Est. Error`,
    `95% HPDI (Lower)`,
    `95% HPDI (Upper)`,
    `Pd`,
    `Bulk ESS`,
    `Tail ESS`,
    `R-hat`,
    Significant
  ) %>%
  gt(rowname_col = "Parameter") %>%
  fmt_number(
    columns = c("Estimate", "Est. Error", "95% HPDI (Lower)", "95% HPDI (Upper)"),
    decimals = 2
  ) %>%
  fmt_number(columns = "Pd", decimals = 3) %>%
  fmt_number(columns = "R-hat", decimals = 3) %>%
  fmt_number(columns = c("Bulk ESS", "Tail ESS"), decimals = 0, use_seps = TRUE) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(rows = Significant == TRUE)
  ) %>%
  cols_hide(columns = "Significant") %>%
  tab_header(title = "Posterior Estimates for Litter Biomass (Non-Interaction Model)")

print(LitterB_gt_table_nonI)

gtsave(
  LitterB_gt_table_nonI,
  "C:/Users/DrewIvory/OneDrive - University of Florida/Desktop/School/PHD/01_Projects/01_FuelDynamics/02_Data/Posterior_Probabilities/LitterB_Posterior_nonI_Table.rtf"
)


```

## Conditional Effects Litter Biomass
```{r Conditional_Effects_Litter_Biomass, echo=FALSE}
# Plot the conditional effects
#conditional_effects(LT_Bio_model_student) %>%
#  plot() +
#  labs(title = "Conditional Effects of litter Biomass Model") +
#  theme_minimal()


litterB_ce_status_season <- conditional_effects(LT_Bio_model_student, effects = "Status:Season")
litterB_df <- litterB_ce_status_season[["Status:Season"]]

litterB_df$Status <- factor(litterB_df$Status,
                    levels = c("Non_Invaded", "Invaded"),
                    labels = c("Non-Invaded", "Invaded"))

ggplot(litterB_df, aes(x = Season, y = estimate__, group = Season, color = Season)) +
  geom_point(position = position_dodge(width = 0.5), size = 3) +
  geom_errorbar(aes(ymin = lower__, ymax = upper__), 
                width = 0.2, position = position_dodge(width = 0.5)) +
  geom_line(position = position_dodge(width = 0.5)) +
  facet_wrap(~Status) +
  labs(
    # title = "Estimated Litter Biomass by Season and Invasion Status",  # Removed
    x = "Season",
    y = expression("Litter Biomass (" * t %.% ha^{-1} * ")"),
    color = "Season"
  ) +
  scale_color_manual(values = c("Spring" = "#1b9e77", "Summer" = "#d95f02", "Winter" = "#7570b3")) +
  scale_y_continuous(limits = c(0, NA), expand = expansion(mult = c(0, 0.25))) +
  theme_minimal(base_size = 16) +
  theme(
    panel.grid.major.x = element_blank(),      # Remove major vertical grid lines
    panel.grid.minor = element_blank(),        # Remove all minor grid lines
    panel.grid.major.y = element_line(color = "gray80", size = 0.5),  # Keep major horizontal grid lines
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 14),
    strip.text = element_text(size = 16),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    legend.position = "top"
    )

```


## GLMM Live Moisture
```{r GLMM_Live_Moisture, include=FALSE}

LV_Moisture_model_student <- brm(avg_live_moisture_content ~
                            Status * Season +
                            Status * Latitude +
                             (1 | Site),
                            data = merged_sites,
                           family = student(),
                           chains = 4,
                           iter = 4000,
                           warmup = 1000,
                           control = list(adapt_delta = 0.95)
                           )

LV_Moisture_model_nonI <- brm(avg_live_moisture_content ~
                            Status + Season +
                            Latitude +
                             (1 | Site),
                            data = merged_sites,
                           family = student(),
                           chains = 4,
                           iter = 4000,
                           warmup = 1000,
                           control = list(adapt_delta = 0.95)
                           )

```

## Model Comparison
```{r compare_LV_Moisture, echo=FALSE}
# Compare models with Leave-One-Out Cross-Validation
loo_student_LV_Moisture <- loo(LV_Moisture_model_student)

summary(LV_Moisture_model_student)
summary(LV_Moisture_model_nonI)

# Plot the posterior predictive checks
pp_check(LV_Moisture_model_student) +
  labs(title = "Posterior Predictive Check for Live Moisture Model") +
  theme_minimal()

# Plot the relationship between invasion status and surface rate of spread
merged_sites %>%
  ggplot(aes(x = Status, y = avg_live_moisture_content, color = Season)) +
  geom_boxplot() +
  geom_jitter(width = 0.2, alpha = 0.2) +
  labs(title = "Live Moisture by Invasion Status and Season",
       x = "Invasion Status",
       y = "Live Moisture (%)",
       color = "Season") +
  theme_minimal()

merged_sites %>%
  ggplot(aes(x = Season, y = avg_live_moisture_content, color = Season)) +
  geom_boxplot() +
  geom_jitter(width = 0.2, alpha = 0.2) +
  labs(title = "",
       x = "Season",
       y = "Live Moisture (%)",
       color = "Season") +
  theme_minimal()
```

## Estimated marginal means
```{r emmeans_Live_Moisture, echo=FALSE}
emm_results <- emmeans(LV_Moisture_model_student, specs = ~ Status | Season)


pairwise_comparisons <- pairs(emm_results, reverse = TRUE)

print(pairwise_comparisons)

# exact posterior probability
exact_pp <- p_direction(pairwise_comparisons)

print(exact_pp)
```

## Live Moisture Summary Table
```{r Live_Moisture_Summary, echo=FALSE}
# ---- Summarize posterior draws ----
rhat_values_df <- enframe(
  brms::rhat(LV_Moisture_model_student),
  name = "Parameter_raw",
  value = "Rhat"
)

LiveM_summary_df <- as_draws_df(LV_Moisture_model_student) %>%
  select(starts_with("b_")) %>%
  pivot_longer(
    cols      = everything(),
    names_to  = "Parameter_raw",
    values_to = "Value"
  ) %>%
  group_by(Parameter_raw) %>%
  summarise(
    Estimate        = median(Value),
    `Est. Error`    = mad(Value),
    `95% HPDI (Lower)` = hdi(Value, ci = 0.95)$CI_low,
    `95% HPDI (Upper)` = hdi(Value, ci = 0.95)$CI_high,
    `Pd` = max(mean(Value > 0), mean(Value < 0)),
    `Bulk ESS`        = posterior::ess_bulk(Value),
    `Tail ESS`        = posterior::ess_tail(Value),
    `R-hat`           = posterior::rhat(Value),
    .groups = "drop"
  ) %>%
  mutate(
    Parameter = gsub("b_", "", Parameter_raw),
    Parameter = gsub("StatusInvaded", "Status-Invaded", Parameter),
    Parameter = gsub("SeasonSpring", "Season-Spring", Parameter),
    Parameter = gsub("SeasonWinter", "Season-Winter", Parameter),
    Parameter = gsub("Latitude", "Latitude", Parameter),
    Parameter = gsub(":", " x ", Parameter),
    Parameter = if_else(Parameter == "Intercept", "(Intercept)", Parameter)
  )

LiveM_gt_table <- LiveM_summary_df %>%
  mutate(Significant = Pd >= 0.95) %>%
  select(
    Parameter,
    Estimate,
    `Est. Error`,
    `95% HPDI (Lower)`,
    `95% HPDI (Upper)`,
    `Pd`,
    `Bulk ESS`,
    `Tail ESS`,
    `R-hat`,
    Significant
  ) %>%
  gt(rowname_col = "Parameter") %>%
  fmt_number(
    columns = c("Estimate", "Est. Error", "95% HPDI (Lower)", "95% HPDI (Upper)"),
    decimals = 2
  ) %>%
  fmt_number(columns = "Pd", decimals = 3) %>%
  fmt_number(columns = "R-hat", decimals = 3) %>%
  fmt_number(columns = c("Bulk ESS", "Tail ESS"), decimals = 0, use_seps = TRUE) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(rows = Significant == TRUE)
  ) %>%
  cols_hide(columns = "Significant") %>%
  tab_header(title = "Posterior Estimates for Live Moisture")

print(LiveM_gt_table)

gtsave(
  LiveM_gt_table,
  "C:/Users/DrewIvory/OneDrive - University of Florida/Desktop/School/PHD/01_Projects/01_FuelDynamics/02_Data/Posterior_Probabilities/LiveM_Posterior_Table.rtf"
)


```

## Live Moisture Summary Table- NonI
```{r Live_Moisture_Summary_NonI, echo=FALSE}
# ---- Summarize posterior draws ----
rhat_values_df <- enframe(
  brms::rhat(LV_Moisture_model_nonI),
  name = "Parameter_raw",
  value = "Rhat"
)

LiveM_summary_df_nonI <- as_draws_df(LV_Moisture_model_nonI) %>%
  select(starts_with("b_")) %>%
  pivot_longer(
    cols      = everything(),
    names_to  = "Parameter_raw",
    values_to = "Value"
  ) %>%
  group_by(Parameter_raw) %>%
  summarise(
    Estimate        = median(Value),
    `Est. Error`    = mad(Value),
    `95% HPDI (Lower)` = hdi(Value, ci = 0.95)$CI_low,
    `95% HPDI (Upper)` = hdi(Value, ci = 0.95)$CI_high,
    `Pd` = max(mean(Value > 0), mean(Value < 0)),
    `Bulk ESS`        = posterior::ess_bulk(Value),
    `Tail ESS`        = posterior::ess_tail(Value),
    `R-hat`           = posterior::rhat(Value),
    .groups = "drop"
  ) %>%
  mutate(
    Parameter = gsub("b_", "", Parameter_raw),
    Parameter = gsub("StatusInvaded", "Status-Invaded", Parameter),
    Parameter = gsub("SeasonSpring", "Season-Spring", Parameter),
    Parameter = gsub("SeasonWinter", "Season-Winter", Parameter),
    Parameter = gsub("Latitude", "Latitude", Parameter),
    Parameter = if_else(Parameter == "Intercept", "(Intercept)", Parameter)
  )

LiveM_gt_table_nonI <- LiveM_summary_df_nonI %>%
  mutate(Significant = Pd >= 0.95) %>%
  select(
    Parameter,
    Estimate,
    `Est. Error`,
    `95% HPDI (Lower)`,
    `95% HPDI (Upper)`,
    `Pd`,
    `Bulk ESS`,
    `Tail ESS`,
    `R-hat`,
    Significant
  ) %>%
  gt(rowname_col = "Parameter") %>%
  fmt_number(
    columns = c("Estimate", "Est. Error", "95% HPDI (Lower)", "95% HPDI (Upper)"),
    decimals = 2
  ) %>%
  fmt_number(columns = "Pd", decimals = 3) %>%
  fmt_number(columns = "R-hat", decimals = 3) %>%
  fmt_number(columns = c("Bulk ESS", "Tail ESS"), decimals = 0, use_seps = TRUE) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(rows = Significant == TRUE)
  ) %>%
  cols_hide(columns = "Significant") %>%
  tab_header(title = "Posterior Estimates for Live Moisture (Non-Interaction Model)")

print(LiveM_gt_table_nonI)

gtsave(
  LiveM_gt_table_nonI,
  "C:/Users/DrewIvory/OneDrive - University of Florida/Desktop/School/PHD/01_Projects/01_FuelDynamics/02_Data/Posterior_Probabilities/LiveM_Posterior_nonI_Table.rtf"
)

```

## Conditional Effects Live Moisture
```{r Conditional_Effects_Live_Moisture, echo=FALSE}
# Plot the conditional effects
#conditional_effects(LV_Moisture_model_student) %>%
#  plot() +
#  labs(title = "Conditional Effects of Live Moisture Model") +
#  theme_minimal()

liveM_ce_status_season <- conditional_effects(LV_Moisture_model_student, effects = "Status:Season")
liveM_df <- liveM_ce_status_season[["Status:Season"]]

liveM_df$Status <- factor(liveM_df$Status,
                    levels = c("Non_Invaded", "Invaded"),
                    labels = c("Non-Invaded", "Invaded"))

ggplot(liveM_df, aes(x = Season, y = estimate__, group = Season, color = Season)) +
  geom_point(position = position_dodge(width = 0.5), size = 3) +
  geom_errorbar(aes(ymin = lower__, ymax = upper__), 
                width = 0.2, position = position_dodge(width = 0.5)) +
  geom_line(position = position_dodge(width = 0.5)) +
  facet_wrap(~Status) +
  labs(
    # title = "Estimated Live Moisture by Season and Invasion Status",  # Removed
    x = "Season",
    y = "Live Moisture (%)",
    color = "Season"
  ) +
  scale_color_manual(values = c("Spring" = "#1b9e77", "Summer" = "#d95f02", "Winter" = "#7570b3")) +
  scale_y_continuous(limits = c(0, NA), expand = expansion(mult = c(0, 0.25))) +
  theme_minimal(base_size = 16) +
  theme(
    panel.grid.major.x = element_blank(),      # Remove major vertical grid lines
    panel.grid.minor = element_blank(),        # Remove all minor grid lines
    panel.grid.major.y = element_line(color = "gray80", size = 0.5),  # Keep major horizontal grid lines
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 14),
    strip.text = element_text(size = 16),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    legend.position = "top"
    )


```

## GLMM Dead Moisture
```{r GLMM_Dead_Moisture, include=FALSE}

D_Moisture_model_student <- brm(avg_dead_moisture_content ~
                            Status * Season +
                            Status * Latitude +
                             (1 | Site),
                            data = merged_sites,
                           family = student(),
                           chains = 4,
                           iter = 4000,
                           warmup = 1000,
                           control = list(adapt_delta = 0.95)
                           )

D_Moisture_model_nonI <- brm(avg_dead_moisture_content ~
                            Status + Season +
                            Latitude +
                             (1 | Site),
                            data = merged_sites,
                           family = student(),
                           chains = 4,
                           iter = 4000,
                           warmup = 1000,
                           control = list(adapt_delta = 0.95)
                           )

```

## Model Comparison
```{r compare_D_Moisture, echo=FALSE}
# Compare models with Leave-One-Out Cross-Validation
loo_student_D_Moisture <- loo(D_Moisture_model_student)

summary(D_Moisture_model_student)
summary(D_Moisture_model_nonI)

# Plot the posterior predictive checks
pp_check(D_Moisture_model_student) +
  labs(title = "Posterior Predictive Check for Dead Moisture Model") +
  theme_minimal()

# Plot the relationship between invasion status and surface rate of spread
merged_sites %>%
  ggplot(aes(x = Status, y = avg_dead_moisture_content, color = Season)) +
  geom_boxplot() +
  geom_jitter(width = 0.2, alpha = 0.2) +
  labs(title = "Dead Moisture by Invasion Status and Season",
       x = "Invasion Status",
       y = "Dead Moisture (%)",
       color = "Season") +
  theme_minimal()

merged_sites %>%
  ggplot(aes(x = Season, y = avg_dead_moisture_content, color = Season)) +
  geom_boxplot() +
  geom_jitter(width = 0.2, alpha = 0.2) +
  labs(title = "",
       x = "Season",
       y = "Dead Moisture (%)",
       color = "Season") +
  theme_minimal()
```

## Estimated marginal means
```{r emmeans_Dead_Moisture, echo=FALSE}
emm_results <- emmeans(D_Moisture_model_student, specs = ~ Status | Season)


pairwise_comparisons <- pairs(emm_results, reverse = TRUE)

print(pairwise_comparisons)

# exact posterior probability
exact_pp <- p_direction(pairwise_comparisons)

print(exact_pp)
```

## Dead Moisture Summary Table
```{r Dead_Moisture_Summary, echo=FALSE}
# ---- Summarize posterior draws ----
rhat_values_df <- enframe(
  brms::rhat(D_Moisture_model_student),
  name = "Parameter_raw",
  value = "Rhat"
)

DeadM_summary_df <- as_draws_df(D_Moisture_model_student) %>%
  select(starts_with("b_")) %>%
  pivot_longer(
    cols      = everything(),
    names_to  = "Parameter_raw",
    values_to = "Value"
  ) %>%
  group_by(Parameter_raw) %>%
  summarise(
    Estimate        = median(Value),
    `Est. Error`    = mad(Value),
    `95% HPDI (Lower)` = hdi(Value, ci = 0.95)$CI_low,
    `95% HPDI (Upper)` = hdi(Value, ci = 0.95)$CI_high,
    `Pd` = max(mean(Value > 0), mean(Value < 0)),
    `Bulk ESS`        = posterior::ess_bulk(Value),
    `Tail ESS`        = posterior::ess_tail(Value),
    `R-hat`           = posterior::rhat(Value),
    .groups = "drop"
  ) %>%
  mutate(
    Parameter = gsub("b_", "", Parameter_raw),
    Parameter = gsub("StatusInvaded", "Status-Invaded", Parameter),
    Parameter = gsub("SeasonSpring", "Season-Spring", Parameter),
    Parameter = gsub("SeasonWinter", "Season-Winter", Parameter),
    Parameter = gsub("Latitude", "Latitude", Parameter),
    Parameter = gsub(":", " x ", Parameter),
    Parameter = if_else(Parameter == "Intercept", "(Intercept)", Parameter)
  )

DeadM_gt_table <- DeadM_summary_df %>%
  mutate(Significant = Pd >= 0.95) %>%
  select(
    Parameter,
    Estimate,
    `Est. Error`,
    `95% HPDI (Lower)`,
    `95% HPDI (Upper)`,
    `Pd`,
    `Bulk ESS`,
    `Tail ESS`,
    `R-hat`,
    Significant
  ) %>%
  gt(rowname_col = "Parameter") %>%
  fmt_number(
    columns = c("Estimate", "Est. Error", "95% HPDI (Lower)", "95% HPDI (Upper)"),
    decimals = 2
  ) %>%
  fmt_number(columns = "Pd", decimals = 3) %>%
  fmt_number(columns = "R-hat", decimals = 3) %>%
  fmt_number(columns = c("Bulk ESS", "Tail ESS"), decimals = 0, use_seps = TRUE) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(rows = Significant == TRUE)
  ) %>%
  cols_hide(columns = "Significant") %>%
  tab_header(title = "Posterior Estimates for Dead Moisture")

print(DeadM_gt_table)

gtsave(
  DeadM_gt_table,
  "C:/Users/DrewIvory/OneDrive - University of Florida/Desktop/School/PHD/01_Projects/01_FuelDynamics/02_Data/Posterior_Probabilities/DeadM_Posterior_Table.rtf")
```

## Dead Moisture Summary Table- NonI
```{r Dead_Moisture_Summary_NonI, echo=FALSE}
# ---- Summarize posterior draws ----
rhat_values_df <- enframe(
  brms::rhat(D_Moisture_model_nonI),
  name = "Parameter_raw",
  value = "Rhat"
)

DeadM_summary_df_nonI <- as_draws_df(D_Moisture_model_nonI) %>%
  select(starts_with("b_")) %>%
  pivot_longer(
    cols      = everything(),
    names_to  = "Parameter_raw",
    values_to = "Value"
  ) %>%
  group_by(Parameter_raw) %>%
  summarise(
    Estimate        = median(Value),
    `Est. Error`    = mad(Value),
    `95% HPDI (Lower)` = hdi(Value, ci = 0.95)$CI_low,
    `95% HPDI (Upper)` = hdi(Value, ci = 0.95)$CI_high,
    `Pd` = max(mean(Value > 0), mean(Value < 0)),
    `Bulk ESS`        = posterior::ess_bulk(Value),
    `Tail ESS`        = posterior::ess_tail(Value),
    `R-hat`           = posterior::rhat(Value),
    .groups = "drop"
  ) %>%
  mutate(
    Parameter = gsub("b_", "", Parameter_raw),
    Parameter = gsub("StatusInvaded", "Status-Invaded", Parameter),
    Parameter = gsub("SeasonSpring", "Season-Spring", Parameter),
    Parameter = gsub("SeasonWinter", "Season-Winter", Parameter),
    Parameter = gsub("Latitude", "Latitude", Parameter),
    Parameter = if_else(Parameter == "Intercept", "(Intercept)", Parameter)
  )

DeadM_gt_table_nonI <- DeadM_summary_df_nonI %>%
  mutate(Significant = Pd >= 0.95) %>%
  select(
    Parameter,
    Estimate,
    `Est. Error`,
    `95% HPDI (Lower)`,
    `95% HPDI (Upper)`,
    `Pd`,
    `Bulk ESS`,
    `Tail ESS`,
    `R-hat`,
    Significant
  ) %>%
  gt(rowname_col = "Parameter") %>%
  fmt_number(
    columns = c("Estimate", "Est. Error", "95% HPDI (Lower)", "95% HPDI (Upper)"),
    decimals = 2
  ) %>%
  fmt_number(columns = "Pd", decimals = 3) %>%
  fmt_number(columns = "R-hat", decimals = 3) %>%
  fmt_number(columns = c("Bulk ESS", "Tail ESS"), decimals = 0, use_seps = TRUE) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(rows = Significant == TRUE)
  ) %>%
  cols_hide(columns = "Significant") %>%
  tab_header(title = "Posterior Estimates for Dead Moisture (Non-Interaction Model)")

print(DeadM_gt_table_nonI)

gtsave(
  DeadM_gt_table_nonI,
  "C:/Users/DrewIvory/OneDrive - University of Florida/Desktop/School/PHD/01_Projects/01_FuelDynamics/02_Data/Posterior_Probabilities/DeadM_Posterior_nonI_Table.rtf")
```

## Conditional Effects Dead Moisture
```{r Conditional_Effects_Dead_Moisture, echo=FALSE}
# Plot the conditional effects
#conditional_effects(D_Moisture_model_student) %>%
#  plot() +
#  labs(title = "Conditional Effects of Dead Moisture Model") +
#  theme_minimal()

deadM_ce_status_season <- conditional_effects(D_Moisture_model_student, effects = "Status:Season")
deadM_df <- deadM_ce_status_season[["Status:Season"]]

deadM_df$Status <- factor(deadM_df$Status,
                    levels = c("Non_Invaded", "Invaded"),
                    labels = c("Non-Invaded", "Invaded"))

ggplot(deadM_df, aes(x = Season, y = estimate__, group = Season, color = Season)) +
  geom_point(position = position_dodge(width = 0.5), size = 3) +
  geom_errorbar(aes(ymin = lower__, ymax = upper__), 
                width = 0.2, position = position_dodge(width = 0.5)) +
  geom_line(position = position_dodge(width = 0.5)) +
  facet_wrap(~Status) +
  labs(
    # title = "Estimated Dead Moisture by Season and Invasion Status",  # Removed
    x = "Season",
    y = "Dead Moisture (%)",
    color = "Season"
  ) +
  scale_color_manual(values = c("Spring" = "#1b9e77", "Summer" = "#d95f02", "Winter" = "#7570b3")) +
  scale_y_continuous(limits = c(0, NA), expand = expansion(mult = c(0, 0.25))) +
  theme_minimal(base_size = 16) +
  theme(
    panel.grid.major.x = element_blank(),      # Remove major vertical grid lines
    panel.grid.minor = element_blank(),        # Remove all minor grid lines
    panel.grid.major.y = element_line(color = "gray80", size = 0.5),  # Keep major horizontal grid lines
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 14),
    strip.text = element_text(size = 16),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    legend.position = "top"
    )


```


## GLMM Litter Moisture
```{r GLMM_Litter_Moisture, include=FALSE}

LT_Moisture_model_student <- brm(avg_litter_moisture_content ~
                            Status * Season +
                            Status * Latitude +
                             (1 | Site),
                            data = merged_sites,
                           family = student(),
                           chains = 4,
                           iter = 4000,
                           warmup = 1000,
                           control = list(adapt_delta = 0.95)
                           )

LT_Moisture_model_nonI <- brm(avg_litter_moisture_content ~
                            Status + Season +
                            Latitude +
                             (1 | Site),
                            data = merged_sites,
                           family = student(),
                           chains = 4,
                           iter = 4000,
                           warmup = 1000,
                           control = list(adapt_delta = 0.95)
                           )

```

## Model Comparison
```{r compare_LT_Moisture, echo=FALSE}
# Compare models with Leave-One-Out Cross-Validation
#loo_gaussian_LT_Moisture <- loo(LT_Moisture_model_gaussian)
loo_student_LT_Moisture <- loo(LT_Moisture_model_student)

# Model comparison
#loo_compare(loo_gaussian_LT_Moisture, loo_student_LT_Moisture)

summary(LT_Moisture_model_student)
summary(LT_Moisture_model_nonI)

# Plot the posterior predictive checks
pp_check(LT_Moisture_model_student) +
  labs(title = "Posterior Predictive Check for Litter Moisture Model") +
  theme_minimal()

# Plot the relationship between invasion status and surface rate of spread
merged_sites %>%
  ggplot(aes(x = Status, y = avg_litter_moisture_content, color = Season)) +
  geom_boxplot() +
  geom_jitter(width = 0.2, alpha = 0.2) +
  labs(title = "Litter Moisture by Invasion Status and Season",
       x = "Invasion Status",
       y = "Litter Moisture (%)",
       color = "Season") +
  theme_minimal()

merged_sites %>%
  ggplot(aes(x = Season, y = avg_litter_moisture_content, color = Season)) +
  geom_boxplot() +
  geom_jitter(width = 0.2, alpha = 0.2) +
  labs(title = "",
       x = "Season",
       y = "Litter Moisture (%)",
       color = "Season") +
  theme_minimal()
```

## Estimated marginal means
```{r emmeans_Litter_Moisture, echo=FALSE}
emm_results <- emmeans(LT_Moisture_model_student, specs = ~ Status | Season)


pairwise_comparisons <- pairs(emm_results, reverse = TRUE)

print(pairwise_comparisons)

# exact posterior probability
exact_pp <- p_direction(pairwise_comparisons)

print(exact_pp)
```

## Litter Moisture Summary Table
```{r Litter_Moisture_Summary, echo=FALSE}
# ---- Summarize posterior draws ----
rhat_values_df <- enframe(
  brms::rhat(LT_Moisture_model_student),
  name = "Parameter_raw",
  value = "Rhat"
)

LitterM_summary_df <- as_draws_df(LT_Moisture_model_student) %>%
  select(starts_with("b_")) %>%
  pivot_longer(
    cols      = everything(),
    names_to  = "Parameter_raw",
    values_to = "Value"
  ) %>%
  group_by(Parameter_raw) %>%
  summarise(
    Estimate        = median(Value),
    `Est. Error`    = mad(Value),
    `95% HPDI (Lower)` = hdi(Value, ci = 0.95)$CI_low,
    `95% HPDI (Upper)` = hdi(Value, ci = 0.95)$CI_high,
    `Pd` = max(mean(Value > 0), mean(Value < 0)),
    `Bulk ESS`        = posterior::ess_bulk(Value),
    `Tail ESS`        = posterior::ess_tail(Value),
    `R-hat`           = posterior::rhat(Value),
    .groups = "drop"
  ) %>%
  mutate(
    Parameter = gsub("b_", "", Parameter_raw),
    Parameter = gsub("StatusInvaded", "Status-Invaded", Parameter),
    Parameter = gsub("SeasonSpring", "Season-Spring", Parameter),
    Parameter = gsub("SeasonWinter", "Season-Winter", Parameter),
    Parameter = gsub("Latitude", "Latitude", Parameter),
    Parameter = gsub(":", " x ", Parameter),
    Parameter = if_else(Parameter == "Intercept", "(Intercept)", Parameter)
  )

LitterM_gt_table <- LitterM_summary_df %>%
  mutate(Significant = Pd >= 0.95) %>%
  select(
    Parameter,
    Estimate,
    `Est. Error`,
    `95% HPDI (Lower)`,
    `95% HPDI (Upper)`,
    `Pd`,
    `Bulk ESS`,
    `Tail ESS`,
    `R-hat`,
    Significant
  ) %>%
  gt(rowname_col = "Parameter") %>%
  fmt_number(
    columns = c("Estimate", "Est. Error", "95% HPDI (Lower)", "95% HPDI (Upper)"),
    decimals = 2
  ) %>%
  fmt_number(columns = "Pd", decimals = 3) %>%
  fmt_number(columns = "R-hat", decimals = 3) %>%
  fmt_number(columns = c("Bulk ESS", "Tail ESS"), decimals = 0, use_seps = TRUE) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(rows = Significant == TRUE)
  ) %>%
  cols_hide(columns = "Significant") %>%
  tab_header(title = "Posterior Estimates for Litter Moisture")

print(LitterM_gt_table)

gtsave(
  LitterM_gt_table,
  "C:/Users/DrewIvory/OneDrive - University of Florida/Desktop/School/PHD/01_Projects/01_FuelDynamics/02_Data/Posterior_Probabilities/LitterM_Posterior_Table.rtf"
)

```

## Litter Moisture Summary Table- NonI
```{r Litter_Moisture_Summary_NonI, echo=FALSE}
# ---- Summarize posterior draws ----
rhat_values_df <- enframe(
  brms::rhat(LT_Moisture_model_nonI),
  name = "Parameter_raw",
  value = "Rhat"
)

LitterM_summary_df_nonI <- as_draws_df(LT_Moisture_model_nonI) %>%
  select(starts_with("b_")) %>%
  pivot_longer(
    cols      = everything(),
    names_to  = "Parameter_raw",
    values_to = "Value"
  ) %>%
  group_by(Parameter_raw) %>%
  summarise(
    Estimate        = median(Value),
    `Est. Error`    = mad(Value),
    `95% HPDI (Lower)` = hdi(Value, ci = 0.95)$CI_low,
    `95% HPDI (Upper)` = hdi(Value, ci = 0.95)$CI_high,
    `Pd` = max(mean(Value > 0), mean(Value < 0)),
    `Bulk ESS`        = posterior::ess_bulk(Value),
    `Tail ESS`        = posterior::ess_tail(Value),
    `R-hat`           = posterior::rhat(Value),
    .groups = "drop"
  ) %>%
  mutate(
    Parameter = gsub("b_", "", Parameter_raw),
    Parameter = gsub("StatusInvaded", "Status-Invaded", Parameter),
    Parameter = gsub("SeasonSpring", "Season-Spring", Parameter),
    Parameter = gsub("SeasonWinter", "Season-Winter", Parameter),
    Parameter = gsub("Latitude", "Latitude", Parameter),
    Parameter = if_else(Parameter == "Intercept", "(Intercept)", Parameter)
  )

LitterM_gt_table_nonI <- LitterM_summary_df_nonI %>%
  mutate(Significant = Pd >= 0.95) %>%
  select(
    Parameter,
    Estimate,
    `Est. Error`,
    `95% HPDI (Lower)`,
    `95% HPDI (Upper)`,
    `Pd`,
    `Bulk ESS`,
    `Tail ESS`,
    `R-hat`,
    Significant
  ) %>%
  gt(rowname_col = "Parameter") %>%
  fmt_number(
    columns = c("Estimate", "Est. Error", "95% HPDI (Lower)", "95% HPDI (Upper)"),
    decimals = 2
  ) %>%
  fmt_number(columns = "Pd", decimals = 3) %>%
  fmt_number(columns = "R-hat", decimals = 3) %>%
  fmt_number(columns = c("Bulk ESS", "Tail ESS"), decimals = 0, use_seps = TRUE) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(rows = Significant == TRUE)
  ) %>%
  cols_hide(columns = "Significant") %>%
  tab_header(title = "Posterior Estimates for Litter Moisture (Non-Interaction Model)")

print(LitterM_gt_table_nonI)

gtsave(
  LitterM_gt_table_nonI,
  "C:/Users/DrewIvory/OneDrive - University of Florida/Desktop/School/PHD/01_Projects/01_FuelDynamics/02_Data/Posterior_Probabilities/LitterM_Posterior_nonI_Table.rtf"
)

```



## Conditional Effects Litter Moisture
```{r Conditional_Effects_Litter_Moisture, echo=FALSE}
# Plot the conditional effects
#conditional_effects(LT_Moisture_model_student) %>%
#  plot() +
#  labs(title = "Conditional Effects of Litter Moisture Model") +
#  theme_minimal()

litterM_ce_status_season <- conditional_effects(LT_Moisture_model_student, effects = "Status:Season")
litterM_df <- litterM_ce_status_season[["Status:Season"]]

litterM_df$Status <- factor(litterM_df$Status,
                    levels = c("Non_Invaded", "Invaded"),
                    labels = c("Non-Invaded", "Invaded"))

ggplot(litterM_df, aes(x = Season, y = estimate__, group = Season, color = Season)) +
  geom_point(position = position_dodge(width = 0.5), size = 3) +
  geom_errorbar(aes(ymin = lower__, ymax = upper__), 
                width = 0.2, position = position_dodge(width = 0.5)) +
  geom_line(position = position_dodge(width = 0.5)) +
  facet_wrap(~Status) +
  labs(
    # title = "Estimated Litter Moisture by Season and Invasion Status",  # Removed
    x = "Season",
    y = "Litter Moisture (%)",
    color = "Season"
  ) +
  scale_color_manual(values = c("Spring" = "#1b9e77", "Summer" = "#d95f02", "Winter" = "#7570b3")) +
  scale_y_continuous(limits = c(0, NA), expand = expansion(mult = c(0, 0.25))) +
  theme_minimal(base_size = 16) +
  theme(
    panel.grid.major.x = element_blank(),      # Remove major vertical grid lines
    panel.grid.minor = element_blank(),        # Remove all minor grid lines
    panel.grid.major.y = element_line(color = "gray80", size = 0.5),  # Keep major horizontal grid lines
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 14),
    strip.text = element_text(size = 16),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    legend.position = "top"
    )


```


## GLMM Soil Moisture
```{r GLMM_Soil_Moisture, include=FALSE}

Soil_Moisture_model_student <- brm(avg_soil_moisture ~
                            Status * Season +
                            Status * Latitude +
                             (1 | Site),
                            data = merged_sites,
                           family = student(),
                           chains = 4,
                           iter = 4000,
                           warmup = 1000,
                           control = list(adapt_delta = 0.95)
                           )

Soil_Moisture_model_nonI <- brm(avg_soil_moisture ~
                            Status + Season +
                            Latitude +
                             (1 | Site),
                            data = merged_sites,
                           family = student(),
                           chains = 4,
                           iter = 4000,
                           warmup = 1000,
                           control = list(adapt_delta = 0.95)
                           )

```

## Model Comparison
```{r compare_Soil_Moisture, echo=FALSE}
# Compare models with Leave-One-Out Cross-Validation
loo_student_Soil_Moisture <- loo(Soil_Moisture_model_student)

summary(Soil_Moisture_model_student)
summary(Soil_Moisture_model_nonI)

# Plot the posterior predictive checks
pp_check(Soil_Moisture_model_student) +
  labs(title = "Posterior Predictive Check for Soil Moisture Model") +
  theme_minimal()

# Plot the relationship between invasion status and surface rate of spread
merged_sites %>%
  ggplot(aes(x = Status, y = avg_soil_moisture, color = Season)) +
  geom_boxplot() +
  geom_jitter(width = 0.2, alpha = 0.2) +
  labs(title = "Soil Moisture by Invasion Status and Season",
       x = "Invasion Status",
       y = "Soil Moisture (%)",
       color = "Season") +
  theme_minimal()

merged_sites %>%
  ggplot(aes(x = Season, y = avg_soil_moisture, color = Season)) +
  geom_boxplot() +
  geom_jitter(width = 0.2, alpha = 0.2) +
  labs(title = "",
       x = "Season",
       y = "Soil Moisture (%)",
       color = "Season") +
  theme_minimal()
```

## Estimated marginal means
```{r emmeans_Soil_Moisture, echo=FALSE}
emm_results <- emmeans(Soil_Moisture_model_student, specs = ~ Status | Season)


pairwise_comparisons <- pairs(emm_results, reverse = TRUE)

print(pairwise_comparisons)

# exact posterior probability
exact_pp <- p_direction(pairwise_comparisons)

print(exact_pp)
```

## Soil Moisture Summary Table
```{r Soil_Moisture_Summary, echo=FALSE}
# ---- Summarize posterior draws ----
rhat_values_df <- enframe(
  brms::rhat(Soil_Moisture_model_student),
  name = "Parameter_raw",
  value = "Rhat"
)

SoilM_summary_df <- as_draws_df(Soil_Moisture_model_student) %>%
  select(starts_with("b_")) %>%
  pivot_longer(
    cols      = everything(),
    names_to  = "Parameter_raw",
    values_to = "Value"
  ) %>%
  group_by(Parameter_raw) %>%
  summarise(
    Estimate        = median(Value),
    `Est. Error`    = mad(Value),
    `95% HPDI (Lower)` = hdi(Value, ci = 0.95)$CI_low,
    `95% HPDI (Upper)` = hdi(Value, ci = 0.95)$CI_high,
    `Pd` = max(mean(Value > 0), mean(Value < 0)),
    `Bulk ESS`        = posterior::ess_bulk(Value),
    `Tail ESS`        = posterior::ess_tail(Value),
    `R-hat`           = posterior::rhat(Value),
    .groups = "drop"
  ) %>%
  mutate(
    Parameter = gsub("b_", "", Parameter_raw),
    Parameter = gsub("StatusInvaded", "Status-Invaded", Parameter),
    Parameter = gsub("SeasonSpring", "Season-Spring", Parameter),
    Parameter = gsub("SeasonWinter", "Season-Winter", Parameter),
    Parameter = gsub("Latitude", "Latitude", Parameter),
    Parameter = gsub(":", " x ", Parameter),
    Parameter = if_else(Parameter == "Intercept", "(Intercept)", Parameter)
  )

SoilM_gt_table <- SoilM_summary_df %>%
  mutate(Significant = Pd >= 0.95) %>%
  select(
    Parameter,
    Estimate,
    `Est. Error`,
    `95% HPDI (Lower)`,
    `95% HPDI (Upper)`,
    `Pd`,
    `Bulk ESS`,
    `Tail ESS`,
    `R-hat`,
    Significant
  ) %>%
  gt(rowname_col = "Parameter") %>%
  fmt_number(
    columns = c("Estimate", "Est. Error", "95% HPDI (Lower)", "95% HPDI (Upper)"),
    decimals = 2
  ) %>%
  fmt_number(columns = "Pd", decimals = 3) %>%
  fmt_number(columns = "R-hat", decimals = 3) %>%
  fmt_number(columns = c("Bulk ESS", "Tail ESS"), decimals = 0, use_seps = TRUE) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(rows = Significant == TRUE)
  ) %>%
  cols_hide(columns = "Significant") %>%
  tab_header(title = "Posterior Estimates for Soil Moisture")

print(SoilM_gt_table)

gtsave(
  SoilM_gt_table,
  "C:/Users/DrewIvory/OneDrive - University of Florida/Desktop/School/PHD/01_Projects/01_FuelDynamics/02_Data/Posterior_Probabilities/SoilM_Posterior_Table.rtf"
)


```

## Soil Moisture Summary Table- NonI
```{r Soil_Moisture_Summary_NonI, echo=FALSE}
# ---- Summarize posterior draws ----
rhat_values_df <- enframe(
  brms::rhat(Soil_Moisture_model_nonI),
  name = "Parameter_raw",
  value = "Rhat"
)

SoilM_summary_df_nonI <- as_draws_df(Soil_Moisture_model_nonI) %>%
  select(starts_with("b_")) %>%
  pivot_longer(
    cols      = everything(),
    names_to  = "Parameter_raw",
    values_to = "Value"
  ) %>%
  group_by(Parameter_raw) %>%
  summarise(
    Estimate        = median(Value),
    `Est. Error`    = mad(Value),
    `95% HPDI (Lower)` = hdi(Value, ci = 0.95)$CI_low,
    `95% HPDI (Upper)` = hdi(Value, ci = 0.95)$CI_high,
    `Pd` = max(mean(Value > 0), mean(Value < 0)),
    `Bulk ESS`        = posterior::ess_bulk(Value),
    `Tail ESS`        = posterior::ess_tail(Value),
    `R-hat`           = posterior::rhat(Value),
    .groups = "drop"
  ) %>%
  mutate(
    Parameter = gsub("b_", "", Parameter_raw),
    Parameter = gsub("StatusInvaded", "Status-Invaded", Parameter),
    Parameter = gsub("SeasonSpring", "Season-Spring", Parameter),
    Parameter = gsub("SeasonWinter", "Season-Winter", Parameter),
    Parameter = gsub("Latitude", "Latitude", Parameter),
    Parameter = if_else(Parameter == "Intercept", "(Intercept)", Parameter)
  )

SoilM_gt_table_nonI <- SoilM_summary_df_nonI %>%
  mutate(Significant = Pd >= 0.95) %>%
  select(
    Parameter,
    Estimate,
    `Est. Error`,
    `95% HPDI (Lower)`,
    `95% HPDI (Upper)`,
    `Pd`,
    `Bulk ESS`,
    `Tail ESS`,
    `R-hat`,
    Significant
  ) %>%
  gt(rowname_col = "Parameter") %>%
  fmt_number(
    columns = c("Estimate", "Est. Error", "95% HPDI (Lower)", "95% HPDI (Upper)"),
    decimals = 2
  ) %>%
  fmt_number(columns = "Pd", decimals = 3) %>%
  fmt_number(columns = "R-hat", decimals = 3) %>%
  fmt_number(columns = c("Bulk ESS", "Tail ESS"), decimals = 0, use_seps = TRUE) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(rows = Significant == TRUE)
  ) %>%
  cols_hide(columns = "Significant") %>%
  tab_header(title = "Posterior Estimates for Soil Moisture (Non-Interaction Model)")

print(SoilM_gt_table_nonI)

gtsave(
  SoilM_gt_table_nonI,
  "C:/Users/DrewIvory/OneDrive - University of Florida/Desktop/School/PHD/01_Projects/01_FuelDynamics/02_Data/Posterior_Probabilities/SoilM_Posterior_nonI_Table.rtf"
)

```



## Conditional Effects Soil Moisture
```{r Conditional_Effects_Soil_Moisture, echo=FALSE}
# Plot the conditional effects
#conditional_effects(Soil_Moisture_model_student) %>%
#  plot() +
#  labs(title = "Conditional Effects of Soil Moisture Model") +
#  theme_minimal()

soilM_ce_status_season <- conditional_effects(Soil_Moisture_model_student, effects = "Status:Season")
soilM_df <- soilM_ce_status_season[["Status:Season"]]

soilM_df$Status <- factor(soilM_df$Status,
                    levels = c("Non_Invaded", "Invaded"),
                    labels = c("Non-Invaded", "Invaded"))

ggplot(soilM_df, aes(x = Season, y = estimate__, group = Season, color = Season)) +
  geom_point(position = position_dodge(width = 0.5), size = 3) +
  geom_errorbar(aes(ymin = lower__, ymax = upper__), 
                width = 0.2, position = position_dodge(width = 0.5)) +
  geom_line(position = position_dodge(width = 0.5)) +
  facet_wrap(~Status) +
  labs(
    # title = "Estimated Soil Moisture by Season and Invasion Status",  # Removed
    x = "Season",
    y = "Soil Moisture (%)",
    color = "Season"
  ) +
  scale_color_manual(values = c("Spring" = "#1b9e77", "Summer" = "#d95f02", "Winter" = "#7570b3")) +
  scale_y_continuous(limits = c(0, NA), expand = expansion(mult = c(0, 0.25))) +
  theme_minimal(base_size = 16) +
  theme(
    panel.grid.major.x = element_blank(),      # Remove major vertical grid lines
    panel.grid.minor = element_blank(),        # Remove all minor grid lines
    panel.grid.major.y = element_line(color = "gray80", size = 0.5),  # Keep major horizontal grid lines
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 14),
    strip.text = element_text(size = 16),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    legend.position = "top"
    )


```

## GLMM Veg Height
```{r GLMM_Veg_Height, include=FALSE}

Veg_Height_model_student <- brm(avg_height ~
                            Status * Season +
                            Status * Latitude +
                             (1 | Site),
                            data = merged_sites,
                           family = student(),
                           chains = 4,
                           iter = 4000,
                           warmup = 1000,
                           control = list(adapt_delta = 0.95)
                           )

```

## Model Comparison
```{r compare_Veg_Height, echo=FALSE}
# Compare models with Leave-One-Out Cross-Validation
loo_student_Veg_Height <- loo(Veg_Height_model_student)


summary(Veg_Height_model_student)

# Plot the posterior predictive checks
pp_check(Veg_Height_model_student) +
  labs(title = "Posterior Predictive Check for Veg Height Model") +
  theme_minimal()

# Plot the relationship between invasion status and surface rate of spread
merged_sites %>%
  ggplot(aes(x = Status, y = avg_height, color = Season)) +
  geom_boxplot() +
  geom_jitter(width = 0.2, alpha = 0.2) +
  labs(title = "Veg Height by Invasion Status and Season",
       x = "Invasion Status",
       y = "Veg Height (m)",
       color = "Season") +
  theme_minimal()

```


## Estimated marginal means
```{r emmeans_Veg_Height, echo=FALSE}
emm_results <- emmeans(Veg_Height_model_student, specs = ~ Status | Season)


pairwise_comparisons <- pairs(emm_results, reverse = TRUE)

print(pairwise_comparisons)

pw_df <- as.data.frame(pairwise_comparisons)

pw_gt <- pw_df %>%
  gt(groupname_col = "Season") %>%
  tab_header(
    title = "Pairwise Comparisons of Vegetation Height",
    subtitle = "Status effects within each season"
  ) %>%
  fmt_number(
    columns = where(is.numeric),
    decimals = 2
  )

gtsave(
  pw_gt,
  filename = "C:/Users/DrewIvory/OneDrive - University of Florida/Desktop/School/PHD/01_Projects/01_FuelDynamics/02_Data/Posterior_Probabilities/Veg_Height_Pairwise_Status_by_Season.rtf"
)



# exact posterior probability
exact_pp <- p_direction(pairwise_comparisons)

print(exact_pp)
```

## Veg Height Summary Table
```{r Veg_Height_Summary, echo=FALSE}
# ---- Summarize posterior draws ----
rhat_values_df <- enframe(
  brms::rhat(Veg_Height_model_student),
  name = "Parameter_raw",
  value = "Rhat"
)

VegH_summary_df <- as_draws_df(Veg_Height_model_student) %>%
  select(starts_with("b_")) %>%
  pivot_longer(
    cols      = everything(),
    names_to  = "Parameter_raw",
    values_to = "Value"
  ) %>%
  group_by(Parameter_raw) %>%
  summarise(
    Estimate        = median(Value),
    `Est. Error`    = mad(Value),
    `95% HPDI (Lower)` = hdi(Value, ci = 0.95)$CI_low,
    `95% HPDI (Upper)` = hdi(Value, ci = 0.95)$CI_high,
    `Pd` = max(mean(Value > 0), mean(Value < 0)),
    `Bulk ESS`        = posterior::ess_bulk(Value),
    `Tail ESS`        = posterior::ess_tail(Value),
    `R-hat`           = posterior::rhat(Value),
    .groups = "drop"
  ) %>%
  mutate(
    Parameter = gsub("b_", "", Parameter_raw),
    Parameter = gsub("StatusInvaded", "Status-Invaded", Parameter),
    Parameter = gsub("SeasonSpring", "Season-Spring", Parameter),
    Parameter = gsub("SeasonWinter", "Season-Winter", Parameter),
    Parameter = gsub("Latitude", "Latitude", Parameter),
    Parameter = gsub(":", " x ", Parameter),
    Parameter = if_else(Parameter == "Intercept", "(Intercept)", Parameter)
  )

VegH_gt_table <- VegH_summary_df %>%
  mutate(Significant = Pd >= 0.95) %>%
  select(
    Parameter,
    Estimate,
    `Est. Error`,
    `95% HPDI (Lower)`,
    `95% HPDI (Upper)`,
    `Pd`,
    `Bulk ESS`,
    `Tail ESS`,
    `R-hat`,
    Significant
  ) %>%
  gt(rowname_col = "Parameter") %>%
  fmt_number(
    columns = c("Estimate", "Est. Error", "95% HPDI (Lower)", "95% HPDI (Upper)"),
    decimals = 2
  ) %>%
  fmt_number(columns = "Pd", decimals = 3) %>%
  fmt_number(columns = "R-hat", decimals = 3) %>%
  fmt_number(columns = c("Bulk ESS", "Tail ESS"), decimals = 0, use_seps = TRUE) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(rows = Significant == TRUE)
  ) %>%
  cols_hide(columns = "Significant") %>%
  tab_header(title = "Posterior Estimates for Vegetation Height")

print(VegH_gt_table)

gtsave(
  VegH_gt_table,
  "C:/Users/DrewIvory/OneDrive - University of Florida/Desktop/School/PHD/01_Projects/01_FuelDynamics/02_Data/Posterior_Probabilities/VegH_Posterior_Table.rtf"
)


```

## Conditional Effects Veg Height
```{r Conditional_Effects_Veg_Height, echo=FALSE}
# Plot the conditional effects
#conditional_effects(Veg_Height_model_student) %>%
#  plot() +
#  labs(title = "Conditional Effects of Veg Height Model") +
#  theme_minimal()

vegH_ce_status_season <- conditional_effects(Veg_Height_model_student, effects = "Status:Season")
vegH_df <- vegH_ce_status_season[["Status:Season"]]

vegH_df$Status <- factor(vegH_df$Status,
                    levels = c("Non_Invaded", "Invaded"),
                    labels = c("Non-Invaded", "Invaded"))

ggplot(vegH_df, aes(x = Season, y = estimate__, group = Season, color = Season)) +
  geom_point(position = position_dodge(width = 0.5), size = 3) +
  geom_errorbar(aes(ymin = lower__, ymax = upper__), 
                width = 0.2, position = position_dodge(width = 0.5)) +
  geom_line(position = position_dodge(width = 0.5)) +
  facet_wrap(~Status) +
  labs(
    # title = "Estimated Veg Height by Season and Invasion Status",  # Removed
    x = "Season",
    y = "Veg Height (m)",
    color = "Season"
  ) +
  scale_color_manual(values = c("Spring" = "#1b9e77", "Summer" = "#d95f02", "Winter" = "#7570b3")) +
  scale_y_continuous(limits = c(0, NA), expand = expansion(mult = c(0, 0.25))) +
  theme_minimal(base_size = 16) +
  theme(
    panel.grid.major.x = element_blank(),      # Remove major vertical grid lines
    panel.grid.minor = element_blank(),        # Remove all minor grid lines
    panel.grid.major.y = element_line(color = "gray80", size = 0.5),  # Keep major horizontal grid lines
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 14),
    strip.text = element_text(size = 16),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    legend.position = "top"
    )

vegH_ce_status_latitude <- conditional_effects(
  Veg_Height_model_student,
  effects = "Latitude:Status"
)

plot_data_vegH <- vegH_ce_status_latitude[["Latitude:Status"]]

custom_colors <- c(
  "Invaded" = "#0072B2",
  "Non_Invaded" = "#D55E00"
)

ggplot() +
  geom_ribbon(
    data = plot_data_vegH,
    aes(x = Latitude, ymin = lower__, ymax = upper__, fill = Status),
    alpha = 0.2
  ) +
  geom_line(
    data = plot_data_vegH,
    aes(x = Latitude, y = estimate__, color = Status),
    linewidth = 1
  ) +
  geom_point(
    data = merged_sites,
    aes(x = Latitude, y = avg_height, color = Status),
    alpha = 0.5
  ) +
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  labs(
    x = "Latitude (\u00B0)",
    y = "Vegetation Height (m)"
  ) +
  scale_y_continuous(
    breaks = seq(0, 3, by = 0.5)
  ) +
  coord_cartesian(ylim = c(0, 3)) +
  theme_minimal(base_size = 12) +
  theme(
    legend.position = c(0.98, 0.98),
    legend.justification = c("right", "top"),
    legend.background = element_rect(
      fill = alpha("white", 0.8),
      color = "grey70"
    ),
    legend.key = element_blank(),
    legend.title = element_blank()
  ) +
  guides(fill = "none")

```

## Merge Plot
```{r Merge_Plot, echo=FALSE}
#--------------------------------------------
# 1. Theme
#--------------------------------------------
#merged_sites$Status <- factor(
#  merged_sites$Status,
#  levels = c("Non_Invaded", "Invaded"),
#  labels = c("Non-Invaded", "Invaded")
#)


merged_sites$Season <- factor(
  merged_sites$Season,
  levels = c("Spring", "Summer", "Winter")
)


my_theme <- theme_minimal(base_size = 18) +
  theme(
    axis.title   = element_text(size = 26, face = "bold"),
    axis.text    = element_text(size = 24),
    axis.text.x = element_text(size = 24, face = "bold"),
    axis.line    = element_line(color = "black", linewidth = 0.8),
    axis.ticks   = element_line(color = "black", linewidth = 0.6),

    plot.title   = element_text(size = 22, face = "bold", hjust = 0.5),

    legend.title = element_text(size = 20, face = "bold"),
    legend.text  = element_text(size = 18),

    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_line(color = "grey75", linewidth = 0.9),
    panel.grid.minor.y = element_line(color = "grey88", linewidth = 0.5),

    plot.tag     = element_text(size = 24, face = "bold")
  )


# --------------------------------------------
# 2. Color palette
# --------------------------------------------
uf_colors <- c(
  "Summer" = "coral",
  "Winter" = "steelblue",
  "Spring"   = "#228B22"
)


#--------------------------------------------
# 3. Function to create individual plots
#--------------------------------------------

make_plot <- function(y, ylab) {
  ggplot(merged_sites, aes(x = Status, y = .data[[y]])) +
    geom_point(
      aes(color = Season),
      position = position_jitterdodge(
        jitter.width = 0.15,
        dodge.width  = 0.7
      ),
      alpha = 0.3, size = 2
    ) +
    geom_boxplot(
      aes(fill = Season),
      position = position_dodge(width = 0.7),
      width = 0.6,
      outlier.shape = NA,
      alpha = 0.9,
      linewidth = 0.8
    ) +
    scale_color_manual(values = uf_colors) +
    scale_fill_manual(values  = uf_colors) +
    expand_limits(y = 0) +
    labs(
      x = NULL,
      y = ylab,
      color = "Season",
      fill  = "Season"
    ) +
    my_theme
}


#--------------------------------------------
# 4. Build the individual plots
#--------------------------------------------


plots <- list(
  liveB = make_plot("avg_live_biomass",          "Live Fuel Load (t ha)"),
  deadB = make_plot("avg_dead_biomass",          "Dead Fuel Load (t ha)"),
  litterB = make_plot("avg_litter_biomass",      "Litter Fuel Load (t ha)"),
  liveM = make_plot("avg_live_moisture_content", "Live Moisture (%)"),
  deadM = make_plot("avg_dead_moisture_content", "Dead Moisture (%)"),
  litterM = make_plot("avg_litter_moisture_content", "Litter Moisture (%)"),
  soilM = make_plot("avg_soil_moisture",         "Soil Moisture (%)"),
  vegH  = make_plot("avg_height",                "Vegetation Height (m)")
)

#--------------------------------------------
# 5. Remove x-axis text/ticks for all but bottom row
#--------------------------------------------
no_x <- theme(axis.title.x = element_blank(),
              axis.text.x  = element_blank(),
              axis.ticks.x = element_blank())

plots_top6 <- lapply(plots[1:6], `+`, no_x)   
plots_bot2 <- plots[7:8]                      

#--------------------------------------------
# 6. Arrange with patchwork
#--------------------------------------------
combined_patchwork <-
  (plots_top6[[1]] + plots_top6[[2]]) /
  (plots_top6[[3]] + plots_top6[[4]]) /
  (plots_top6[[5]] + plots_top6[[6]]) /
  (plots_bot2[[1]] + plots_bot2[[2]]) +
  plot_layout(guides = "collect") &            
  theme(legend.position = "bottom")

combined_patchwork <- combined_patchwork +
  plot_annotation(tag_levels = "A")


p1 <- plots[[1]]   # liveB
p8 <- plots[[8]]   # vegH

combined_1_8 <- p1 / p8 + 
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")

combined_1_8 <- combined_1_8 +
  plot_annotation(tag_levels = "A")

combined_1_8
#--------------------------------------------
# 7. Save
#--------------------------------------------

ggsave(
  filename = "C:/Users/DrewIvory/OneDrive - University of Florida/Desktop/School/PHD/01_Projects/01_FuelDynamics/03_Figure/O1/combined_season_plot.png",
  plot = combined_1_8,
  width = 16, height = 20, dpi = 300
)

```

## Latitude Plot
```{r Latitude_Plot, echo=FALSE}
my_theme <- theme_minimal(base_size = 18) +
  theme(
    axis.title   = element_text(size = 18, face = "bold"),
    axis.text    = element_text(size = 16),
    axis.text.x = element_text(size = 16, face = "bold"),
    axis.line    = element_line(color = "black", linewidth = 0.8),
    axis.ticks   = element_line(color = "black", linewidth = 0.6),

    plot.title   = element_text(size = 22, face = "bold", hjust = 0.5),

    legend.title = element_text(size = 20, face = "bold"),
    legend.text  = element_text(size = 18),

    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_line(color = "grey75", linewidth = 0.9),
    panel.grid.minor.y = element_line(color = "grey88", linewidth = 0.5),

    plot.tag     = element_text(size = 24, face = "bold")
  )


status_colors <- c(
  "Invaded"     = "#0072B2",
  "Non_Invaded" = "#D55E00"
)

p_fuel_lat <- ggplot() +
  geom_ribbon(
    data = plot_data,
    aes(
      x = Latitude,
      ymin = lower__,
      ymax = upper__,
      fill = Status
    ),
    alpha = 0.25
  ) +
  geom_line(
    data = plot_data,
    aes(
      x = Latitude,
      y = estimate__,
      color = Status
    ),
    linewidth = 1.2
  ) +
  geom_point(
    data = merged_sites,
    aes(
      x = Latitude,
      y = avg_live_biomass,
      color = Status
    ),
    alpha = 0.35,
    size = 2.5
  ) +
  scale_color_manual(
  values = status_colors,
  labels = c(
    "Invaded"     = "Invaded",
    "Non_Invaded" = "Non-Invaded"
  )
) +
scale_fill_manual(
  values = status_colors,
  labels = c(
    "Invaded"     = "Invaded",
    "Non_Invaded" = "Non-Invaded"
    )
  )+
  scale_y_continuous(breaks = seq(0, 11, by = 2)) +
  coord_cartesian(ylim = c(0, 11)) +
  labs(
    x = NULL,
    y = "Live Fuel Load (t ha)"
  ) +
  my_theme +
  theme(
    legend.position = "none",
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )



p_vegH_lat <- ggplot() +
  geom_ribbon(
    data = plot_data_vegH,
    aes(
      x = Latitude,
      ymin = lower__,
      ymax = upper__,
      fill = Status
    ),
    alpha = 0.25
  ) +
  geom_line(
    data = plot_data_vegH,
    aes(
      x = Latitude,
      y = estimate__,
      color = Status
    ),
    linewidth = 1.2
  ) +
  geom_point(
    data = merged_sites,
    aes(
      x = Latitude,
      y = avg_height,
      color = Status
    ),
    alpha = 0.35,
    size = 2.5
  ) +
  scale_color_manual(
  values = status_colors,
  labels = c(
    "Invaded"     = "Invaded",
    "Non_Invaded" = "Non-Invaded"
  )
) +
scale_fill_manual(
  values = status_colors,
  labels = c(
    "Invaded"     = "Invaded",
    "Non_Invaded" = "Non-Invaded"
    )
  )+
  scale_y_continuous(breaks = seq(0, 3, by = 0.5)) +
  coord_cartesian(ylim = c(0, 3)) +
  labs(
    x = "Latitude ()",
    y = "Vegetation Height (m)"
  ) +
  my_theme +
  theme(
    legend.position = "none"
  )



combined_latitude <- 
  p_fuel_lat / p_vegH_lat +
  plot_layout(heights = c(1.1, 1), guides = "collect") &
  theme(
    legend.position = "bottom",
    legend.title = element_text(size = 20, face = "bold"),
    legend.text  = element_text(size = 18)
  )

combined_latitude <- combined_latitude +
  plot_annotation(tag_levels = "A")

combined_latitude




## Save
ggsave(
  filename = "C:/Users/DrewIvory/OneDrive - University of Florida/Desktop/School/PHD/01_Projects/01_FuelDynamics/03_Figure/O1/combined_latitude_plot.png",
  plot = combined_latitude,
  width = 8, height = 10, dpi = 300
)
```


